<!DOCTYPE html>
<html>
<head>
    <title>Earthcal Entry</title>
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            padding-top: 100px;
        }
        #spinner {
            font-size: 24px;
        }
    </style>
</head>
<body>
<div id="spinner">üîÑ Loading Earthcal...</div>

<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
<script>
    async function initApp() {
        const redirectTarget = "dashboard.html";

        // Offline fallback
        if (!navigator.onLine) {
            alert(`You are offline. Redirecting to: ${redirectTarget}`);
            window.location.href = redirectTarget;
            return;
        }

        let buwanaId = null;

        try {
            const token = localStorage.getItem("buwana_token");
            if (!token) throw new Error("No token found");

            const decoded = jwt_decode(token);
            buwanaId = decoded?.buwana_id;
            if (!buwanaId) throw new Error("No buwana_id in token");

            const res = await fetch("https://buwana.ecobricks.org/api/userinfo.php", {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });

            if (res.ok) {
                const user = await res.json();
                console.log("‚úÖ Retrieved user:", user);
                sessionStorage.setItem("buwana_user", JSON.stringify(user));
            }
        } catch (e) {
            console.warn("‚ö†Ô∏è Auth check failed:", e);
        }

        // üåø Fetch calendar data
        if (buwanaId) {
            try {
                const calRes = await fetch("https://buwana.ecobricks.org/earthcal/fetch_all_calendars.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ buwana_id: buwanaId })
                });
                const calData = await calRes.json();
                if (calData.success) {
                    console.log("‚úÖ Retrieved calendar data:", calData);
                    sessionStorage.setItem("user_calendars", JSON.stringify(calData));
                } else {
                    console.warn("‚ö†Ô∏è Calendar fetch failed:", calData.message);
                }
            } catch (e) {
                console.error("‚ö†Ô∏è Error fetching calendars:", e);
            }
        }

        // üéØ Final redirect
        alert(`Redirecting to: ${redirectTarget}`);
        window.location.href = redirectTarget;
    }

    initApp();
</script>
</body>
</html>
