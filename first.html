<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>EarthCal | Setting up your account</title>
    <link rel="icon" href="assets/icons/favicon.ico" />
    <link rel="preload" href="assets/fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="assets/fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <style>
        :root {
            color-scheme: light dark;
            --background-color: #f5f5f5;
            --card-background: rgba(255, 255, 255, 0.92);
            --text-color: #0d1a26;
            --muted-text: #334155;
            --button-background: #0d1a26;
            --button-text: #f7f9fb;
            --button-hover: #14293a;
            --spinner-track: rgba(13, 26, 38, 0.15);
            --spinner-active: #6c5ce7;
            --shadow-color: rgba(15, 23, 42, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #0d0f1a;
                --card-background: rgba(13, 18, 32, 0.85);
                --text-color: #f7f9fb;
                --muted-text: #cbd5f5;
                --button-background: #f7f9fb;
                --button-text: #0d1a26;
                --button-hover: #e1e7ef;
                --spinner-track: rgba(247, 249, 251, 0.2);
                --spinner-active: #8ab4ff;
                --shadow-color: rgba(0, 0, 0, 0.35);
            }
        }

        @font-face {
            font-family: 'Mulish';
            src: url('assets/fonts/Mulish-Light.ttf') format('truetype');
            font-weight: 300;
            font-style: normal;
            font-display: swap;
        }

        @font-face {
            font-family: 'Mulish';
            src: url('assets/fonts/Mulish-Medium.ttf') format('truetype');
            font-weight: 500;
            font-style: normal;
            font-display: swap;
        }

        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--background-color);
            font-family: 'Mulish', 'Helvetica Neue', Arial, sans-serif;
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .onboarding-card {
            width: min(92vw, 640px);
            padding: clamp(1.5rem, 4vw, 2.75rem);
            border-radius: 28px;
            background: var(--card-background);
            box-shadow: 0 18px 40px var(--shadow-color);
            display: flex;
            flex-direction: column;
            gap: 1.75rem;
            text-align: center;
            backdrop-filter: blur(18px);
        }

        h1 {
            margin: 0;
            font-size: clamp(1.6rem, 5vw, 2.4rem);
            font-weight: 500;
            letter-spacing: -0.015em;
        }

        #status-message {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: clamp(0.95rem, 2.5vw, 1.1rem);
            line-height: 1.6;
            text-align: left;
            color: var(--muted-text);
        }

        #earthcal-spinner {
            display: inline-flex;
            flex-shrink: 0;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            border: 3px solid var(--spinner-track);
            border-top-color: var(--spinner-active);
            animation: spin 0.85s linear infinite;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }

        #earthcal-spinner.spinner-complete {
            animation: none;
            border: none;
            background: transparent;
            width: auto;
            height: auto;
        }

        .status-text {
            flex: 1;
        }

        #get-started-button {
            align-self: center;
            margin-top: 0.5rem;
            padding: 0.85rem 2.75rem;
            font-size: 1rem;
            font-weight: 500;
            color: var(--button-text);
            background-color: var(--button-background);
            border: none;
            border-radius: 999px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.18);
        }

        #get-started-button[aria-disabled="true"],
        #get-started-button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
        }

        #get-started-button:not([aria-disabled="true"]):not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.22);
            background-color: var(--button-hover);
            color: var(--button-text);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 767px) {
            body {
                padding: 1.5rem 0.75rem;
            }

            .onboarding-card {
                width: 100%;
                box-shadow: none;
                border-radius: 20px;
                padding: 1.75rem;
            }

            #status-message {
                flex-direction: column;
                align-items: center;
                text-align: center;
            }

            .status-text {
                text-align: center;
            }
        }

        @media (min-width: 768px) and (max-width: 1199px) {
            body {
                padding: 2rem;
            }

            .onboarding-card {
                width: min(85vw, 720px);
            }
        }

        @media (min-width: 1200px) {
            body {
                padding: 3rem;
            }

            .onboarding-card {
                width: 640px;
            }
        }
    </style>
</head>
<body>
    <main class="onboarding-card" role="main">
        <h1 id="greeting">Welcome to EarthCal.</h1>
        <p id="status-message">
            <span id="earthcal-spinner" role="status" aria-live="polite" aria-label="Loading"></span>
            <span class="status-text">Subscribing you to the 2025 and 2026 Astrological Events Public calendar.   Public calendars are a great way to enrich your Earthcal.  Later you turn these calendars on or off.</span>
        </p>
        <button id="get-started-button" type="button" aria-disabled="true" disabled>Get Started</button>
    </main>

    <script src="js/login-scripts.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const greetingEl = document.getElementById('greeting');
            const statusMessage = document.getElementById('status-message');
            const spinner = document.getElementById('earthcal-spinner');
            const statusText = statusMessage?.querySelector('.status-text');
            const getStartedButton = document.getElementById('get-started-button');

            const setSpinnerActive = () => {
                if (!spinner) return;
                spinner.classList.remove('spinner-complete');
                spinner.textContent = '';
                spinner.setAttribute('role', 'status');
                spinner.setAttribute('aria-label', 'Loading');
            };

            const setSpinnerComplete = (symbol, ariaLabel) => {
                if (!spinner) return;
                spinner.classList.add('spinner-complete');
                spinner.textContent = symbol;
                spinner.setAttribute('role', 'img');
                spinner.setAttribute('aria-label', ariaLabel);
            };

            const params = new URLSearchParams(window.location.search);
            const toInt = (value) => {
                if (value === null || value === undefined) {
                    return null;
                }
                const parsed = Number.parseInt(String(value), 10);
                return Number.isFinite(parsed) && parsed > 0 ? parsed : null;
            };

            const urlBuwanaId = toInt(params.get('buwana_id') ?? params.get('id'));

            const authState = typeof window.isLoggedIn === 'function'
                ? window.isLoggedIn({ returnPayload: true })
                : { isLoggedIn: false, payload: null };

            const payload = authState.payload;
            const firstName = payload?.given_name || payload?.first_name || 'Earthling';
            const sessionBuwanaId = toInt(payload?.buwana_id);
            const buwanaId = urlBuwanaId ?? sessionBuwanaId;

            if (greetingEl) {
                greetingEl.textContent = `Welcome to EarthCal, ${firstName}!`;
            }

            if (!buwanaId) {
                console.error('Unable to locate buwana_id in the current session payload.');
                if (statusText) {
                    statusText.textContent = 'We could not confirm your EarthCal account. Please refresh the page to try again.';
                }
                if (spinner) {
                    setSpinnerComplete('‚ö†Ô∏è', 'Unable to confirm account');
                }
                return;
            }

            try {
                const loginURL = await createJWTloginURL();
                if (loginURL && getStartedButton) {
                    getStartedButton.setAttribute('aria-disabled', 'false');
                    getStartedButton.disabled = false;
                    getStartedButton.addEventListener('click', () => {
                        window.location.href = loginURL;
                    }, { once: true });
                }
            } catch (error) {
                console.error('Unable to generate login URL.', error);
            }

            const subscribeToPublicCalendars = async (userId) => {
                const calendarIds = [52, 53];
                const subscriptionEndpoint = 'api/v1/update_pub_cal_subs.php';
                for (const calendarId of calendarIds) {
                    const response = await fetch(subscriptionEndpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'same-origin',
                        body: JSON.stringify({
                            buwana_id: userId,
                            calendar_id: calendarId,
                            subscribe: true
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Subscription request failed with status ${response.status} for calendar ${calendarId}`);
                    }

                    const json = await response.json();
                    if (!json?.ok) {
                        throw new Error(json?.error || `Unable to subscribe to calendar ${calendarId}`);
                    }
                }
            };

            const spinnerStart = performance.now();

            try {
                setSpinnerActive();

                const checkResponse = await fetch('api/v1/create_my_calendar.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ buwana_id: buwanaId, check_only: true })
                });

                if (!checkResponse.ok) {
                    throw new Error(`User confirmation failed with status ${checkResponse.status}`);
                }

                const checkJson = await checkResponse.json();
                if (!checkJson?.ok || !checkJson?.exists) {
                    throw new Error('User not located in users_tb.');
                }
                console.log(`‚úÖ Confirmed EarthCal account in users_tb for buwana_id ${buwanaId}.`, checkJson.user ?? {});

                const createResponse = await fetch('api/v1/create_my_calendar.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({ buwana_id: buwanaId })
                });

                if (!createResponse.ok) {
                    throw new Error(`Calendar creation failed with status ${createResponse.status}`);
                }

                const createJson = await createResponse.json();
                if (!createJson?.ok) {
                    throw new Error(createJson?.error || 'Unknown error while creating My Calendar');
                }

                console.log('üìÖ My Calendar status:', createJson);

                if (statusText) {
                    statusText.textContent = 'Subscribing you to the 2025 and 2026 Astrological Events Public calendar.   Public calendars are a great way to enrich your Earthcal.  Later you turn these calendars on or off.';
                }

                await subscribeToPublicCalendars(buwanaId);

                const elapsed = performance.now() - spinnerStart;
                if (elapsed < 1000) {
                    await new Promise((resolve) => setTimeout(resolve, 1000 - elapsed));
                }

                if (spinner) {
                    setSpinnerComplete('‚úÖ', 'Public calendar subscriptions confirmed');
                }

                if (statusText) {
                    statusText.textContent = createJson.created
                        ? 'Your My Calendar is ready and the Astrological Events calendars are now part of your EarthCal. Click below to get started.'
                        : 'Your My Calendar was already waiting for you. The Astrological Events calendars are enabled‚Äîclick below to explore!';
                }
            } catch (error) {
                console.error('Unable to complete onboarding steps.', error);
                if (statusText) {
                    statusText.textContent = 'We ran into a hiccup preparing your account. Please refresh the page to try again.';
                }
                if (spinner) {
                    setSpinnerComplete('‚ö†Ô∏è', 'An error occurred');
                }
            }
        });
    </script>
</body>
</html>
