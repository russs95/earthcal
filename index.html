<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Earthcal |  Loading..</title>
    <link rel="icon" href="assets/icons/favicon.ico" />
    <script>
        (function () {
            try {
                const params = new URLSearchParams(window.location.search);
                const buwanaId = params.get("buwana_id") || params.get("id");
                const firstName = params.get("firstname") || params.get("first_name");
                if (buwanaId) {
                    try {
                        localStorage.setItem("buwana_id", buwanaId);
                    } catch (storageError) {
                        console.warn("Unable to store buwana_id in localStorage.", storageError);
                    }
                }

                if (firstName) {
                    window.__EARTHCAL_FIRST_NAME__ = firstName;
                }

                const statusParam = params.get("status");
                const hasFirstTimeFlag = statusParam === "firsttime";
                window.__EARTHCAL_HAS_FIRST_TIME__ = hasFirstTimeFlag;
                window.__EARTHCAL_STATUS_PARAM__ = statusParam;
                window.__EARTHCAL_BUWANA_ID__ = buwanaId;
            } catch (error) {
                console.error("Unable to process onboarding redirect.", error);
            }
        })();
    </script>
    <link rel="preconnect" href="https://buwana.ecobricks.org" crossorigin>
    <!-- Preload critical dashboard resources ttt-->
    <link rel="preload" href="js/earthcal-init.js?v=2.1" as="script">
    <link rel="preload" href="css/light.css?v7" as="style">
    <link rel="preload" href="css/dark.css?v7" as="style">
    <link rel="preload" href="css/1-stylesheet.css" as="style">
    <link rel="stylesheet" href="css/1-stylesheet.css?v=8.3">
    <link rel="preload" href="assets/fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="assets/fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="assets/fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="svgs/up-reg-arrow-dark.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active-hover.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active-hover.svg" as="image">
    <style>
        :root {
            --general-background: rgb(245, 245, 245);
            --emblem-green: #008000;
            --emblem-green-over: #0ca70c;
        }
        html,
        body {
            height: 100%;
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Mulish', sans-serif;
            background-color: var(--general-background);
            background-image: url('webp/earthen-subscription-background-dark.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: black;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        body.first-time {
            /*padding: 20px 16px 60px;*/
        }
        body.first-time-ready {
            justify-content: flex-start;
            overflow: auto;
        }
        body.first-time-ready #onboarding-section {
            display: flex;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --general-background: rgb(13, 15, 26);
                --emblem-green: #2b6d27;
                --emblem-green-over: #41a43c;
            }
            body {
                color: white;
            }
        }
        #initial-load {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 24px 16px 60px;
            box-sizing: border-box;
            gap: 18px;
        }
        .earthcal-logo-spinner {
            width: 111px;
            max-width: 100%;
            height: auto;
            display: block;
        }
        .earthcal-logo-spinner--mini {
            width: 100%;
        }
        .earthcal-logo-spinner path {
            opacity: 0.1;
            transition: opacity 0.2s ease-in-out;
        }
        #loading-progress {
            width: min(280px, 70vw);
            height: 6px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.08);
            overflow: hidden;
            position: relative;
            margin-top: 18px;
        }
        #loading-progress-bar {
            height: 100%;
            width: 0%;
            background: var(--emblem-green);
            transition: width 0.2s ease;
        }
        @media screen and (min-width: 769px) and (max-width: 1200px) {
            .earthcal-logo-spinner:not(.earthcal-logo-spinner--mini) {
                width: 155px;
            }
        }
        @media screen and (min-width: 1201px) {
            .earthcal-logo-spinner:not(.earthcal-logo-spinner--mini) {
                width: 177px;
            }
        }
        .footer {
            position: absolute;
            bottom: 10px;
            font-size: 0.8em;
            color: grey;
        }
        @media screen and (max-width: 768px) {
            body {
                height: 100vh;
            }
            body.first-time {
                padding: 0;
            }
            body.first-time-ready {
                align-items: stretch;
                justify-content: flex-start;
            }
            .footer {
                font-size: 1em;
            }
            .footer img {
                width: 40px;
                height: 40px;
            }
            #onboarding-section {
                width: 100vw;
                max-width: none;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                backdrop-filter: none;
                /*min-height: 100vh;*/
                padding: 32px 20px 40px;
                justify-content: flex-start;
                gap: 1.5rem;
            }
            #status-messages {
                flex: 1;
                width: 100%;
            }
        }
        @media screen and (min-width: 769px) and (max-width: 1200px) {
            #onboarding-section {
                width: min(82vw, 640px);
            }
        }
        #onboarding-time {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin: auto;
        }
        #onboarding-section {
            display: none;
            width: min(92vw, 640px);
            max-width: 640px;
            margin-top: 24px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 24px;
            padding: clamp(1.5rem, 5vw, 2.5rem);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            flex-direction: column;
            align-items: center;
            gap: clamp(1rem, 4vw, 1.75rem);
            text-align: center;
            color: inherit;
            backdrop-filter: blur(12px);
            overflow-y: auto;
        }
        @media (prefers-color-scheme: dark) {
            #onboarding-section {
                background: rgba(13, 18, 32, 0.85);
                box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
            }
            #loading-progress {
                background: rgba(255, 255, 255, 0.12);
            }


        }
        #welcome-message {
            margin: 0;
        }
        #generic-welcome {
            margin: 0;
        }
        #status-messages {
            width: 100%;
        }
        #status-message {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            text-align: left;
        }
        #earthcal-spinner {
            display: inline-flex;
            flex-shrink: 0;
            width: 2.25rem;
            height: 2.25rem;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
        }
        #earthcal-spinner .earthcal-logo-spinner {
            width: 100%;
            height: auto;
        }
        #earthcal-spinner .spinner-symbol {
            display: none;
            font-size: 1.75rem;
        }
        #earthcal-spinner.spinner-complete .earthcal-logo-spinner {
            display: none;
        }
        #earthcal-spinner.spinner-complete .spinner-symbol {
            display: inline;
        }
        .status-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            font-size: clamp(0.95rem, 2.5vw, 1.05rem);
            color: rgba(15, 23, 42, 0.75);
        }
        .status-text p {
            margin: 0;
        }
        @media (prefers-color-scheme: dark) {
            .status-text {
                color: rgba(226, 232, 240, 0.85);
            }
        }
        #task-log {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        #task-log li {
            margin: 0;
        }
        #task-log li.task-log-error {
            color: #b91c1c;
        }
        #get-started-button {
            align-self: center;
            margin-top: 0.5rem;
            padding: 0.85rem 2.75rem;
            font-size: 1rem;
            font-weight: 500;
            color: #f7f9fb;
            background-color: var(--emblem-green, #0d1a26);
            border: none;
            border-radius: 999px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.18);
        }
        #get-started-button[aria-disabled="true"],
        #get-started-button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
        }
        #get-started-button:not([aria-disabled="true"]):not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.22);
            background-color: var(--emblem-green-over, #14293a);
            color: #f7f9fb;
        }
    </style>
</head>
<body>
    <div id="initial-load" aria-hidden="true">

            <?xml version="1.0" encoding="UTF-8"?>
            <!-- Created with Inkscape (http://www.inkscape.org/) -->
            <svg class="earthcal-logo-spinner" width="103.23mm" height="103.59mm" version="1.1" viewBox="0 0 103.23 103.59" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <defs>
                    <clipPath id="clipPath1">
                        <path d="m0.26065-89.508a90.493 90.493 0 0 0-90.493 90.491 90.493 90.493 0 0 0 90.493 90.493 90.493 90.493 0 0 0 90.493-90.493 90.493 90.493 0 0 0-90.493-90.491zm-1.839 38.279a52.214 52.214 0 0 1 52.214 52.212 52.214 52.214 0 0 1-52.214 52.214 52.214 52.214 0 0 1-52.214-52.214 52.214 52.214 0 0 1 52.214-52.212z" fill="#0ff" stroke-width="0"/>
                    </clipPath>
                </defs>
                <g transform="matrix(.57548 0 0 .57548 51.927 51.306)" clip-path="url(#clipPath1)" stroke-width=".92194">
                    <path data-month="12-december" d="m43.78-77.057a91.197 91.197 0 0 1 33.353 33.408l-79.017 45.531z" fill="#4343ff" opacity=".33" stroke-width=".9342"/>
                    <path data-month="11-november" d="m-0.77143-89.153a90 90 0 0 1 44.989 12.095l-45.065 77.904z" fill="#0cacf5" opacity=".33"/>
                    <path data-month="10-october" transform="translate(1.1223e-6)" d="m-45.782-77.133a90 90 0 0 1 45.225-12.02l-0.29047 90z" fill="#00e6a7" opacity=".33"/>
                    <path data-month="09-september" transform="translate(1.1223e-6)" d="m-78.752-44.219a90 90 0 0 1 32.97-32.915l44.934 77.98z" fill="#00e513" opacity=".33"/>
                    <path data-month="08-august" transform="translate(1.1223e-6)" d="m-90.848 0.77143a90 90 0 0 1 12.095-44.989l77.904 45.065z" fill="#beee00" opacity=".33"/>
                    <path data-month="07-july" transform="translate(1.1223e-6)" d="m-78.827 45.782a90 90 0 0 1-12.02-45.01l90 0.075889z" fill="#fbfb00" opacity=".33"/>
                    <path data-month="06-june" transform="translate(1.1223e-6)" d="m-45.914 78.752a90 90 0 0 1-32.915-32.97l77.98-44.934z" fill="#ffd119" opacity=".33"/>
                    <path data-month="05-may" transform="translate(1.1223e-6)" d="m-0.92271 90.847a90 90 0 0 1-44.989-12.095l45.065-77.904z" fill="#ff8201" opacity=".33"/>
                    <path data-month="04-april" transform="translate(1.1223e-6)" d="m44.087 78.827a90 90 0 0 1-45.01 12.02l0.075889-90z" fill="#ff6303" opacity=".33"/>
                    <path data-month="03-march" transform="translate(1.1223e-6)" d="m77.057 45.913a90 90 0 0 1-32.97 32.915l-44.934-77.98z" fill="#fb0000" opacity=".33"/>
                    <path data-month="02-february" transform="translate(1.1223e-6)" d="m89.152 0.92271a90 90 0 0 1-12.095 44.989l-77.904-45.065z" fill="#ff11ce" opacity=".33"/>
                    <path data-month="01-january" transform="translate(1.1223e-6)" d="m77.309-43.817c7.8877 13.688 11.857 28.941 11.844 44.74l-90-0.075889z" fill="#7f2aff" opacity=".33"/>
                </g>
            </svg>

        <div id="loading-progress" role="presentation" aria-hidden="true">
            <div id="loading-progress-bar"></div>
        </div>

        <div class="footer" style="text-align: center">
            <a href="https://earthen.io" target="_blank" rel="noopener" aria-label="Visit Earthen">
                <img class="earthen-logo" src="svgs/earthen-icon.svg" style="width:44px;height:44px;">
            </a>
            <p>EarthCal v1.0.0 by Earthen</p>
        </div>
    </div>


<div id="onboarding-time" hidden>

    <main id="onboarding-section" role="main" hidden>
        <h1 id="welcome-message" class="modal-header">Welcome Earthling</h1>
        <p id="generic-welcome" class="modal-description" hidden>Looks like this is your first time logging into EarthCal! Let's get your account setup.</p>
        <div id="status-messages" hidden>
            <div id="status-message">
                <span id="earthcal-spinner" role="status" aria-live="polite" aria-label="Loading">
                    <?xml version="1.0" encoding="UTF-8"?>
                    <!-- Created with Inkscape (http://www.inkscape.org/) -->
                    <svg class="earthcal-logo-spinner earthcal-logo-spinner--mini" width="103.23mm" height="103.59mm" version="1.1" viewBox="0 0 103.23 103.59" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                        <defs>
                            <clipPath id="clipPath-onboard">
                                <path d="m0.26065-89.508a90.493 90.493 0 0 0-90.493 90.491 90.493 90.493 0 0 0 90.493 90.493 90.493 90.493 0 0 0 90.493-90.493 90.493 90.493 0 0 0-90.493-90.491zm-1.839 38.279a52.214 52.214 0 0 1 52.214 52.212 52.214 52.214 0 0 1-52.214 52.214 52.214 52.214 0 0 1-52.214-52.214 52.214 52.214 0 0 1 52.214-52.212z" fill="#0ff" stroke-width="0"/>
                            </clipPath>
                        </defs>
                        <g transform="matrix(.57548 0 0 .57548 51.927 51.306)" clip-path="url(#clipPath-onboard)" stroke-width=".92194">
                            <path data-month="12-december" d="m43.78-77.057a91.197 91.197 0 0 1 33.353 33.408l-79.017 45.531z" fill="#4343ff" opacity=".33" stroke-width=".9342"/>
                            <path data-month="11-november" d="m-0.77143-89.153a90 90 0 0 1 44.989 12.095l-45.065 77.904z" fill="#0cacf5" opacity=".33"/>
                            <path data-month="10-october" transform="translate(1.1223e-6)" d="m-45.782-77.133a90 90 0 0 1 45.225-12.02l-0.2904790z" fill="#00e6a7" opacity=".33"/>
                            <path data-month="09-september" transform="translate(1.1223e-6)" d="m-78.752-44.219a90 90 0 0 1 32.97-32.915l44.934 77.98z" fill="#00e513" opacity=".33"/>
                            <path data-month="08-august" transform="translate(1.1223e-6)" d="m-90.848 0.77143a90 90 0 0 1 12.095-44.989l77.904 45.065z" fill="#beee00" opacity=".33"/>
                            <path data-month="07-july" transform="translate(1.1223e-6)" d="m-78.827 45.782a90 90 0 0 1-12.02-45.01l90 0.075889z" fill="#fbfb00" opacity=".33"/>
                            <path data-month="06-june" transform="translate(1.1223e-6)" d="m-45.914 78.752a90 90 0 0 1-32.915-32.97l77.98-44.934z" fill="#ffd119" opacity=".33"/>
                            <path data-month="05-may" transform="translate(1.1223e-6)" d="m-0.92271 90.847a90 90 0 0 1-44.989-12.095l45.065-77.904z" fill="#ff8201" opacity=".33"/>
                            <path data-month="04-april" transform="translate(1.1223e-6)" d="m44.087 78.827a90 90 0 0 1-45.01 12.02l0.075889-90z" fill="#ff6303" opacity=".33"/>
                            <path data-month="03-march" transform="translate(1.1223e-6)" d="m77.057 45.913a90 90 0 0 1-32.97 32.915l-44.934-77.98z" fill="#fb0000" opacity=".33"/>
                            <path data-month="02-february" transform="translate(1.1223e-6)" d="m89.152 0.92271a90 90 0 0 1-12.095 44.989l-77.904-45.065z" fill="#ff11ce" opacity=".33"/>
                            <path data-month="01-january" transform="translate(1.1223e-6)" d="m77.309-43.817c7.8877 13.688 11.857 28.941 11.844 44.74l-90-0.075889z" fill="#7f2aff" opacity=".33"/>
                        </g>
                    </svg>
                    <span class="spinner-symbol" aria-hidden="true"></span>
                </span>
                <div class="status-text" aria-live="polite">
                    <p id="status-intro">We're preparing your personalized EarthCal experience...</p>
                    <ul id="task-log" role="log" aria-live="polite" aria-busy="true"></ul>
                </div>
            </div>
        </div>
        <button id="get-started-button" type="button" aria-disabled="true" disabled hidden>Get Started</button>
    </main>
    <div class="footer" style="text-align: center">
        <a href="https://earthen.io" target="_blank" rel="noopener" aria-label="Visit Earthen">
            <img class="earthen-logo" src="svgs/earthen-icon.svg" style="width:44px;height:44px;">
        </a>
        <p>EarthCal v1.0.0 by Earthen</p>
    </div>
</div>




<script src="js/earthcal-config.js"></script>
<script src="js/first-onboarding.js"></script>
<script type="module">
    const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    const assets = [
        "js/earthcal-init.js?v=2.1",
        "css/light.css?v7",
        "css/dark.css?v7",
        "css/1-stylesheet.css",
        "fonts/Mulish-Light.ttf",
        "fonts/Mulish-Medium.ttf",
        "fonts/Arvo-Regular.ttf",
        "svgs/up-reg-arrow-dark.svg",
        "svgs/up-reg-arrow-dark-over.svg",
        "svgs/up-reg-arrow-dark-active.svg",
        "svgs/up-reg-arrow-dark-active-hover.svg",
        "svgs/up-reg-arrow-light.svg",
        "svgs/up-reg-arrow-light-over.svg",
        "svgs/up-reg-arrow-light-active.svg",
        "svgs/up-reg-arrow-light-active-hover.svg",
    ];

    const BETA_MIN_HOLD_MS = 20000; // TODO(beta): shorten/remove this hold once beta testing completes.
    const EARTHCAL_ANNIVERSARY_TITLE = "EarthCal Anniversary";

    const loadingProgressBar = document.getElementById("loading-progress-bar");

    const setLoadingProgress = (value) => {
        if (!loadingProgressBar) return;
        const clamped = Math.max(0, Math.min(100, value));
        loadingProgressBar.style.width = `${clamped}%`;
    };

    const preloadAssets = async () => {
        const total = assets.length;
        if (total === 0) {
            setLoadingProgress(100);
            return;
        }
        let loaded = 0;
        setLoadingProgress(0);

        await Promise.all(
            assets.map(async (asset) => {
                try {
                    await fetch(asset);
                } catch (err) {
                    console.warn("Failed to load", asset, err);
                } finally {
                    loaded += 1;
                    setLoadingProgress((loaded / total) * 100);
                }
            })
        );
    };

    const spinEarthcalLogo = () => {
        const STEP_DELAY_MS = 200;
        const INACTIVE_OPACITY = 0.1;
        const ACTIVE_OPACITY = 1;
        const spinners = Array.from(document.querySelectorAll('.earthcal-logo-spinner'));

        if (spinners.length === 0) {
            return;
        }

        spinners.forEach((spinnerEl, spinnerIndex) => {
            const paths = Array.from(spinnerEl.querySelectorAll('[data-month]'));
            if (paths.length === 0) {
                return;
            }

            paths.forEach((path) => {
                path.style.opacity = String(INACTIVE_OPACITY);
            });

            let index = 0;

            const tick = () => {
                const current = paths[index];
                const previous = paths[(index - 1 + paths.length) % paths.length];

                if (previous) {
                    previous.style.opacity = String(INACTIVE_OPACITY);
                }

                if (current) {
                    current.style.opacity = String(ACTIVE_OPACITY);
                }

                index = (index + 1) % paths.length;
                setTimeout(tick, STEP_DELAY_MS);
            };

            setTimeout(tick, spinnerIndex * (STEP_DELAY_MS / 2));
        });
    };

    const parseJwt = (tkn) => {
        try {
            const [, payload] = tkn.split(".");
            return JSON.parse(atob(payload));
        } catch {
            return null;
        }
    };

    const ensureSessionProfile = () => {
        const defaultProfile = {
            first_name: "Earthling",
            earthling_emoji: "🐸",
            email: null,
            buwana_id: null,
            status: "new",
        };

        const token = localStorage.getItem("access_token") || localStorage.getItem("id_token");
        if (!token) {
            sessionStorage.setItem("buwana_user", JSON.stringify(defaultProfile));
            return;
        }

        const payload = parseJwt(token);
        const isValid = payload && (!payload.exp || payload.exp > Math.floor(Date.now() / 1000));
        if (!isValid) {
            sessionStorage.setItem("buwana_user", JSON.stringify(defaultProfile));
            return;
        }

        const profile = JSON.parse(localStorage.getItem("user_profile") || "null");
        if (profile) {
            sessionStorage.setItem("buwana_user", JSON.stringify(profile));
        }
    };

    const handleDefaultFlow = async () => {
        const redirectTarget = "dash.html";

        ensureSessionProfile();

        if (!navigator.onLine) {
            console.warn("⚠️ Offline. Preloading may fail.");
        }

        const holdStartedAt = performance.now();
        await preloadAssets();
        const elapsed = performance.now() - holdStartedAt;
        if (elapsed < BETA_MIN_HOLD_MS) {
            await delay(BETA_MIN_HOLD_MS - elapsed);
        }

        setLoadingProgress(100);
        window.location.href = redirectTarget;
    };

    const handleFirstTimeFlow = async () => {
        document.body.classList.add("first-time");
        const initialLoad = document.getElementById("initial-load");
        const onboardingWrapper = document.getElementById("onboarding-time");
        const holdStartedAt = performance.now();
        await preloadAssets();
        const elapsed = performance.now() - holdStartedAt;
        if (elapsed < BETA_MIN_HOLD_MS) {
            await delay(BETA_MIN_HOLD_MS - elapsed);
        }

        if (initialLoad) {
            initialLoad.style.display = "none";
        }
        if (onboardingWrapper) {
            onboardingWrapper.removeAttribute("hidden");
            onboardingWrapper.style.display = "flex";
        }
        document.body.classList.add("first-time-ready");

        const onboardingSection = document.getElementById("onboarding-section");
        const genericWelcome = document.getElementById("generic-welcome");
        const statusMessages = document.getElementById("status-messages");
        if (onboardingSection) {
            onboardingSection.removeAttribute("hidden");
            onboardingSection.style.display = "flex";
        }
        if (genericWelcome) {
            genericWelcome.removeAttribute("hidden");
        }
        if (statusMessages) {
            statusMessages.removeAttribute("hidden");
        }

        await runFirstTimeOnboarding();
    };

    const runFirstTimeOnboarding = async () => {
        const greetingEl = document.getElementById("welcome-message");
        const spinner = document.getElementById("earthcal-spinner");
        const statusIntro = document.getElementById("status-intro");
        const genericWelcome = document.getElementById("generic-welcome");
        const taskLog = document.getElementById("task-log");
        const getStartedButton = document.getElementById("get-started-button");
        let onboardingFailed = false;
        let startButtonHref = null;

        const setSpinnerActive = () => {
            if (!spinner) return;
            const spinnerSymbol = spinner.querySelector(".spinner-symbol");
            spinner.classList.remove("spinner-complete");
            if (spinnerSymbol) {
                spinnerSymbol.textContent = "";
            }
            spinner.setAttribute("role", "status");
            spinner.setAttribute("aria-label", "Loading");
            spinner.removeAttribute("hidden");
        };

        const setSpinnerComplete = (symbol, ariaLabel) => {
            if (!spinner) return;
            const spinnerSymbol = spinner.querySelector(".spinner-symbol");
            spinner.classList.add("spinner-complete");
            if (spinnerSymbol) {
                spinnerSymbol.textContent = symbol;
            }
            spinner.setAttribute("role", "img");
            spinner.setAttribute("aria-label", ariaLabel);
        };

        const normalizeTimeZone = (value) => {
            if (typeof value !== "string") {
                return null;
            }
            const trimmed = value.trim();
            return trimmed.length > 0 ? trimmed : null;
        };

        const toInt = (value) => {
            if (value === null || value === undefined) {
                return null;
            }
            const parsed = Number.parseInt(String(value), 10);
            return Number.isFinite(parsed) && parsed > 0 ? parsed : null;
        };

        const authState = typeof window.isLoggedIn === "function"
            ? window.isLoggedIn({ returnPayload: true })
            : { isLoggedIn: false, payload: null };

        const payload = authState.payload ?? null;
        const profile = window.userProfile ?? null;

        const sanitizeName = (value) => {
            if (typeof value !== "string") {
                return null;
            }
            const trimmed = value.trim();
            return trimmed.length > 0 ? trimmed : null;
        };

        const searchParams = new URLSearchParams(window.location.search);
        const urlFirstName = window.__EARTHCAL_FIRST_NAME__
            || searchParams.get("firstname")
            || searchParams.get("first_name");

        const sanitizedUrlFirstName = sanitizeName(urlFirstName);

        let firstName = sanitizedUrlFirstName || "Earthling";

        const earthlingEmoji = profile?.earthling_emoji
            || payload?.["buwana:earthlingEmoji"]
            || "🌎";

        const buwanaIdValue = window.__EARTHCAL_BUWANA_ID__ || searchParams.get("id") || searchParams.get("buwana_id");
        const buwanaId = toInt(buwanaIdValue);

        const tokenTimeZone = normalizeTimeZone(
            profile?.time_zone
            || payload?.["buwana:timeZone"]
            || payload?.zoneinfo
            || payload?.tzid
            || payload?.time_zone
        );

        const resolvedTimeZone = tokenTimeZone
            || normalizeTimeZone(window.userTimeZone)
            || (() => {
                try {
                    return normalizeTimeZone(Intl.DateTimeFormat().resolvedOptions().timeZone);
                } catch (error) {
                    console.warn("Unable to resolve browser timezone.", error);
                    return null;
                }
            })()
            || "Etc/UTC";

        const defaultCalendarDescription = "Your default, all-purpose personal calendar for general events, to-dos and journals.";

        const updateGreeting = (name) => {
            if (!greetingEl) {
                return;
            }
            const safeName = typeof name === "string" && name.trim().length > 0
                ? name.trim()
                : "Earthling";
            greetingEl.textContent = `Welcome ${safeName}`;
        };

        updateGreeting(firstName);

        if (!buwanaId) {
            console.error("Unable to locate id in the current URL parameters.");
            if (statusIntro) {
                statusIntro.textContent = "We could not confirm your EarthCal account. Please refresh the page to try again.";
            }
            if (spinner) {
                setSpinnerComplete("⚠️", "Unable to confirm account");
            }
            return;
        }

        try {
            if (typeof window.createJWTloginURL === "function") {
                const loginURL = await window.createJWTloginURL();
                if (loginURL) {
                    startButtonHref = loginURL;
                }
            }
        } catch (error) {
            console.error("Unable to generate login URL.", error);
        }

        const subscribeToPublicCalendars = async (userId) => {
            const calendarIds = [52, 53];
            const subscriptionEndpoint = "api/v1/update_pub_cal_subs.php";
            const outcomes = [];
            for (const calendarId of calendarIds) {
                const response = await fetch(subscriptionEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        buwana_id: userId,
                        calendar_id: calendarId,
                        subscribe: true,
                    }),
                });

                if (!response.ok) {
                    if (response.status === 409) {
                        outcomes.push({ calendarId, alreadySubscribed: true });
                        continue;
                    }
                    throw new Error(`Subscription request failed with status ${response.status} for calendar ${calendarId}`);
                }

                const json = await response.json();
                if (!json?.ok) {
                    const errorMessage = typeof json?.error === "string" ? json.error.toLowerCase() : "";
                    if (errorMessage.includes("already")) {
                        outcomes.push({ calendarId, alreadySubscribed: true });
                        continue;
                    }
                    throw new Error(json?.error || `Unable to subscribe to calendar ${calendarId}`);
                }

                const alreadySubscribed = Boolean(
                    json?.alreadySubscribed
                    || json?.already_subscribed
                    || json?.alreadyExists
                    || json?.already_exists
                    || json?.status === "existing"
                );

                outcomes.push({
                    calendarId,
                    alreadySubscribed,
                    subscribed: Boolean(json?.subscribed ?? json?.created ?? json?.ok),
                });
            }

            return outcomes;
        };

        const MIN_TASK_DURATION_MS = 4000;

        const runTask = async (label, action) => {
            const list = taskLog;
            let listItem = null;
            const started = performance.now();
            if (list) {
                listItem = document.createElement("li");
                listItem.textContent = `⏳ ${label}`;
                list.appendChild(listItem);
            }

            try {
                const result = await action();
                const elapsed = performance.now() - started;
                if (elapsed < MIN_TASK_DURATION_MS) {
                    await delay(MIN_TASK_DURATION_MS - elapsed);
                }
                if (listItem) {
                    listItem.textContent = `✅ ${label}`;
                }
                return { result, listItem };
            } catch (taskError) {
                const elapsed = performance.now() - started;
                if (elapsed < MIN_TASK_DURATION_MS) {
                    await delay(MIN_TASK_DURATION_MS - elapsed);
                }
                if (listItem) {
                    listItem.textContent = `⚠️ ${label}`;
                }
                throw taskError;
            }
        };

        const hasExistingAnniversaryEvent = async ({ userId, calendarId }) => {
            if (!userId || !calendarId) {
                return false;
            }

            const numericCalendarId = Number(calendarId);
            if (!Number.isFinite(numericCalendarId)) {
                return false;
            }

            try {
                const response = await fetch("api/v1/get_user_items.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        buwana_id: userId,
                        include_public: false,
                        only_active: true,
                    }),
                });

                if (!response.ok) {
                    console.warn(`Unable to confirm existing anniversary events (status ${response.status}).`);
                    return false;
                }

                const json = await response.json();
                if (!json?.ok || !Array.isArray(json?.calendars)) {
                    return false;
                }

                const normalizedTarget = EARTHCAL_ANNIVERSARY_TITLE.toLowerCase();
                const targetCalendar = json.calendars.find((calendar) => {
                    const calendarIdentifier = Number(calendar?.calendar_id ?? calendar?.calendarId ?? calendar?.id);
                    return Number.isFinite(calendarIdentifier) && calendarIdentifier === numericCalendarId;
                });

                if (!targetCalendar || !Array.isArray(targetCalendar.items)) {
                    return false;
                }

                return targetCalendar.items.some((item) => {
                    if (!item) {
                        return false;
                    }
                    const summary = typeof item.summary === "string" ? item.summary.trim().toLowerCase() : "";
                    return summary === normalizedTarget;
                });
            } catch (error) {
                console.warn("Unable to verify existing EarthCal Anniversary event.", error);
                return false;
            }
        };

        const addAnniversaryEvent = async ({ userId, calendarId, tzid }) => {
            if (!userId || !calendarId) {
                throw new Error("Missing calendar context for the anniversary event.");
            }

            const alreadyScheduled = await hasExistingAnniversaryEvent({ userId, calendarId });
            if (alreadyScheduled) {
                return { alreadyExists: true };
            }

            const safeTzid = tzid || "Etc/UTC";
            const todayInTz = (() => {
                try {
                    const formatter = new Intl.DateTimeFormat("en-CA", {
                        timeZone: safeTzid,
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                    });
                    return formatter.format(new Date());
                } catch (error) {
                    console.warn("Falling back to UTC for anniversary event formatting.", error);
                    return new Date().toISOString().slice(0, 10);
                }
            })();

            const payload = {
                buwana_id: userId,
                calendar_id: calendarId,
                item_kind: "event",
                title: EARTHCAL_ANNIVERSARY_TITLE,
                notes: "You joined Earthcal on this day! Celebrating your transition from linear-time to cycle-time.",
                start_local: `${todayInTz} 00:00:00`,
                tzid: safeTzid,
                all_day: true,
                emoji: "🎉",
            };

            const response = await fetch("api/v1/add_item.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                if (response.status === 409) {
                    return { alreadyExists: true };
                }
                throw new Error(`Anniversary event creation failed with status ${response.status}`);
            }

            const json = await response.json();
            if (!json?.ok) {
                const errorMessage = typeof json?.error === "string" ? json.error.toLowerCase() : "";
                if (errorMessage.includes("already")) {
                    return { alreadyExists: true };
                }
                throw new Error(json?.error || "Unable to add the anniversary event.");
            }

            const alreadyExists = Boolean(
                json?.alreadyExists
                || json?.already_exists
                || json?.status === "existing"
            );

            return {
                alreadyExists,
                created: Boolean(json?.created ?? json?.ok),
            };
        };

        try {
            setSpinnerActive();
            if (statusIntro) {
                statusIntro.textContent = "We are setting up your personalized calendars...";
            }

            let userTimeZone = resolvedTimeZone;
            let calendarId = null;
            let myCalendarCreated = false;
            let calendarTimeZone = resolvedTimeZone;
            const hasTokenTimeZone = Boolean(tokenTimeZone);

            const { result: accountCheckJson, listItem: confirmTaskItem } = await runTask("Confirming your EarthCal account", async () => {
                const checkResponse = await fetch("api/v1/create_my_calendar.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({ buwana_id: buwanaId, check_only: true }),
                });

                if (!checkResponse.ok) {
                    throw new Error(`User confirmation failed with status ${checkResponse.status}`);
                }

                const checkJson = await checkResponse.json();
                if (!checkJson?.ok || !checkJson?.exists) {
                    throw new Error("User not located in users_tb.");
                }
                console.log(`✅ Confirmed EarthCal account in users_tb for buwana_id ${buwanaId}.`, checkJson.user ?? {});
                if (!hasTokenTimeZone && checkJson?.user?.time_zone) {
                    userTimeZone = checkJson.user.time_zone;
                }
                const fetchedFirstName = checkJson?.user?.first_name
                    || checkJson?.user?.firstName
                    || checkJson?.user?.given_name;
                const sanitizedFetchedFirstName = sanitizeName(fetchedFirstName);
                if (!sanitizedUrlFirstName && sanitizedFetchedFirstName) {
                    firstName = sanitizedFetchedFirstName;
                    updateGreeting(firstName);
                }
                return checkJson;
            });

            if (confirmTaskItem) {
                const alreadyExisting = Boolean(accountCheckJson?.exists);
                confirmTaskItem.textContent = alreadyExisting
                    ? "✅ Confirmed your EarthCal account details"
                    : "✅ Created your EarthCal account details";
            }

            const { listItem: calendarTaskItem } = await runTask("Setting up your My Calendar", async () => {
                const createResponse = await fetch("api/v1/create_my_calendar.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        buwana_id: buwanaId,
                        emoji: earthlingEmoji,
                        tzid: userTimeZone,
                        description: defaultCalendarDescription,
                    }),
                });

                if (!createResponse.ok) {
                    throw new Error(`Calendar creation failed with status ${createResponse.status}`);
                }

                const createJson = await createResponse.json();
                if (!createJson?.ok) {
                    throw new Error(createJson?.error || "Unknown error while creating My Calendar");
                }

                console.log("📅 My Calendar status:", createJson);
                const calendar = createJson.calendar ?? null;
                const potentialId = calendar?.calendar_id ?? calendar?.calendarId ?? calendar?.id;
                const parsedId = typeof potentialId === "string" || typeof potentialId === "number"
                    ? Number(potentialId)
                    : null;
                if (Number.isFinite(parsedId)) {
                    calendarId = parsedId;
                }
                myCalendarCreated = Boolean(createJson.created);
                calendarTimeZone = calendar?.tzid || userTimeZone || resolvedTimeZone || "Etc/UTC";
                return createJson;
            });

            if (calendarTaskItem) {
                calendarTaskItem.textContent = myCalendarCreated
                    ? "✅ Created your My Calendar"
                    : "✅ Your My Calendar was already set up";
            }

            const { result: subscriptionResults, listItem: subscriptionTaskItem } = await runTask(
                "Subscribing you to the public 2025 and 2026 Astronomical Events Calendars",
                async () => subscribeToPublicCalendars(buwanaId)
            );

            if (subscriptionTaskItem) {
                const alreadyEnabled = Array.isArray(subscriptionResults)
                    && subscriptionResults.length > 0
                    && subscriptionResults.every((entry) => entry?.alreadySubscribed);
                subscriptionTaskItem.textContent = alreadyEnabled
                    ? "✅ You were already subscribed to the public 2025 and 2026 Astronomical Events Calendars"
                    : "✅ Subscribed you to the public 2025 and 2026 Astronomical Events Calendars";
            }

            const { result: anniversaryResult, listItem: anniversaryTaskItem } = await runTask(
                "Ensuring your 🎉 EarthCal Anniversary celebration is scheduled",
                async () => addAnniversaryEvent({
                    userId: buwanaId,
                    calendarId,
                    tzid: calendarTimeZone || userTimeZone,
                })
            );

            if (anniversaryTaskItem) {
                anniversaryTaskItem.textContent = anniversaryResult?.alreadyExists
                    ? "✅ Your celebration event for today was already on the calendar"
                    : "✅ Added an event for today to celebrate your first login to EarthCal 🎉";
            }

            if (taskLog) {
                taskLog.setAttribute("aria-busy", "false");
            }

            const completionMessage = myCalendarCreated
                ? "Your My Calendar is ready, you're subscribed to the public 2025 and 2026 Astronomical Events Calendars, and we added an event for today to celebrate your first login to EarthCal 🎉. Click below to get started."
                : "Your My Calendar was already waiting for you, so we re-confirmed your Astronomical Events subscriptions and celebration event—everything is ready to explore!";

            if (spinner) {
                setSpinnerComplete("", "Onboarding complete");
                spinner.removeAttribute("aria-label");
                spinner.removeAttribute("role");
                spinner.setAttribute("hidden", "");
            }

            if (statusIntro) {
                statusIntro.textContent = "";
                statusIntro.setAttribute("hidden", "");
            }

            if (genericWelcome) {
                genericWelcome.textContent = completionMessage;
            }
        } catch (error) {
            onboardingFailed = true;
            console.error("Unable to complete onboarding steps.", error);
            if (statusIntro) {
                statusIntro.textContent = "We ran into a hiccup preparing your account. Please refresh the page to try again.";
            }
            if (spinner) {
                setSpinnerComplete("⚠️", "An error occurred");
            }
            if (taskLog) {
                taskLog.setAttribute("aria-busy", "false");
                const errorItem = document.createElement("li");
                errorItem.textContent = error instanceof Error ? `Details: ${error.message}` : "An unexpected error occurred.";
                errorItem.classList.add("task-log-error");
                taskLog.appendChild(errorItem);
            }
        } finally {
            if (getStartedButton) {
                getStartedButton.textContent = onboardingFailed ? "Continue" : "Get Started";
                getStartedButton.removeAttribute("hidden");
                getStartedButton.disabled = false;
                getStartedButton.setAttribute("aria-disabled", "false");
                const destination = startButtonHref || "dash.html";
                getStartedButton.addEventListener("click", () => {
                    window.location.href = destination;
                }, { once: true });
            }
        }
    };

    (async function initApp() {
        spinEarthcalLogo();
        const hasFirstTimeFlag = Boolean(window.__EARTHCAL_HAS_FIRST_TIME__);
        if (hasFirstTimeFlag) {
            await handleFirstTimeFlow();
        } else {
            await handleDefaultFlow();
        }
    })();
</script>
</body>
</html>
