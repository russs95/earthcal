<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Earthcal |  Loading..</title>
    <link rel="icon" href="assets/icons/favicon.ico" />
    <link rel="preconnect" href="https://buwana.ecobricks.org" crossorigin>
    <!-- Preload critical dashboard resources ttt-->
    <link rel="preload" href="js/earthcal-init.js?v=2.1" as="script">
    <link rel="preload" href="css/light.css?v7" as="style">
    <link rel="preload" href="css/dark.css?v7" as="style">
    <link rel="preload" href="css/1-stylesheet.css" as="style">
    <link rel="preload" href="assets/fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="assets/fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="assets/fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="svgs/up-reg-arrow-dark.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active-hover.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active-hover.svg" as="image">
    <style>
        :root {
            --general-background: rgb(245, 245, 245);
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            background-color: var(--general-background);
            color: black;
            transition: all 0.3s ease;
            position: relative;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --general-background: rgb(13, 15, 26);
            }
            body {
                color: white;
            }
        }
        #progress-container {
            width: 100px;
            height: 10px;
            background-color: #333;
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: none;
        }
        #load-progress {
            width: 0%;
            height: 100%;
            background-color: #ccc;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        @media (prefers-color-scheme: dark) {
            #progress-container {
                background-color: #ccc;
            }
            #load-progress {
                background-color: #333;
            }
        }
        #footer {
            position: absolute;
            bottom: 10px;
            font-size: 0.8em;
            color: grey;
        }
        .earthcal-app-logo,
        .earthcal-app-logo svg {
            width: 120px;
            height: 120px;
        }
        @media screen and (max-width: 768px) {
            .earthcal-app-logo,
            .earthcal-app-logo svg {
                width: 180px;
                height: 180px;
            }
            #progress-container {
                width: 150px;
                height: 15px;
            }
            #footer {
                font-size: 1em;
            }
            #footer img {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
<div class="earthcal-app-logo" style="margin-bottom: 20px;text-align: center;">

    <svg
            width="120px"
            height="120px"
            version="1.1"
            viewBox="0 0 103.23278 103.58668"
            id="svg5"
            sodipodi:docname="earthcal-icon.svg"
            inkscape:version="1.4.2 (2aeb623e1d, 2025-05-12)"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
            xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:svg="http://www.w3.org/2000/svg">
        <sodipodi:namedview
                id="namedview5"
                pagecolor="#ffffff"
                bordercolor="#000000"
                borderopacity="0.25"
                inkscape:showpageshadow="2"
                inkscape:pageopacity="0.0"
                inkscape:pagecheckerboard="0"
                inkscape:deskcolor="#d1d1d1"
                inkscape:document-units="mm"
                inkscape:zoom="1.0395666"
                inkscape:cx="284.73404"
                inkscape:cy="404.49549"
                inkscape:window-width="1033"
                inkscape:window-height="697"
                inkscape:window-x="167"
                inkscape:window-y="32"
                inkscape:window-maximized="0"
                inkscape:current-layer="svg5" />
        <defs
                id="defs1">
            <clipPath
                    id="clipPath5535">
                <path
                        d="m 393.29,-172.81 a 52.077,52.077 0 0 0 -52.077,52.076 52.077,52.077 0 0 0 52.077,52.077 52.077,52.077 0 0 0 52.077,-52.077 52.077,52.077 0 0 0 -52.077,-52.076 z m -1.0583,22.029 a 30.048,30.048 0 0 1 30.048,30.047 30.048,30.048 0 0 1 -30.048,30.048 30.048,30.048 0 0 1 -30.048,-30.048 30.048,30.048 0 0 1 30.048,-30.047 z"
                        fill="#00ffff"
                        stroke-width="0"
                        id="path1" />
            </clipPath>
        </defs>
        <g
                transform="translate(-341.213,172.60604)"
                clip-path="url(#clipPath5535)"
                id="g3">
            <g
                    transform="matrix(0.57548,0,0,0.57548,393.14,-121.3)"
                    stroke-width="0.92194"
                    id="g2">
                <path
                        id="october"
                        d="m -45.782,-77.133 a 90,90 0 0 1 45.225,-12.02 l -0.29047,90 z"
                        fill="#00e6a7" />
                <path
                        id="september"
                        d="m -78.752,-44.219 a 90,90 0 0 1 32.97,-32.915 l 44.934,77.98 z"
                        fill="#00e513" />
                <path
                        id="august"
                        d="m -90.848,0.77143 a 90,90 0 0 1 12.095,-44.989 l 77.904,45.065 z"
                        fill="#beee00" />
                <path
                        d="m -78.827,45.782 a 90,90 0 0 1 -12.02,-45.01 l 90,0.075889 z"
                        fill="#fbfb00"
                        id="path2" />
                <path
                        id="june"
                        d="M -45.914,78.752 A 90,90 0 0 1 -78.829,45.782 L -0.849,0.848 Z"
                        fill="#ffd119" />
                <path
                        id="july"
                        d="m -0.92271,90.847 a 90,90 0 0 1 -44.989,-12.095 l 45.065,-77.904 z"
                        fill="#ff8201" />
                <path
                        id="april"
                        d="m 44.087,78.827 a 90,90 0 0 1 -45.01,12.02 l 0.075889,-90 z"
                        fill="#ff6303" />
                <path
                        id="march"
                        d="M 77.057,45.913 A 90,90 0 0 1 44.087,78.828 L -0.847,0.848 Z"
                        fill="#fb0000" />
                <path
                        id="february"
                        d="m 89.152,0.92271 a 90,90 0 0 1 -12.095,44.989 L -0.847,0.84671 Z"
                        fill="#ff11ce" />
                <path
                        id="january"
                        d="m 77.309,-43.817 c 7.8877,13.688 11.857,28.941 11.844,44.74 l -90,-0.075889 z"
                        fill="#7f2aff" />
                <path
                        id="december"
                        d="m 43.78,-77.057 a 91.197,91.197 0 0 1 33.353,33.408 L -1.884,1.882 Z"
                        fill="#4343ff"
                        stroke-width="0.9342" />
                <path
                        id="november"
                        d="m -0.77143,-89.153 a 90,90 0 0 1 44.989,12.095 l -45.065,77.904 z"
                        fill="#0cacf5" />
            </g>
        </g>
    </svg>

</div>
<div id="progress-container">
    <div id="load-progress"></div>
</div>


<div id="footer" style="text-align: center">
    <img src="svgs/earthen-icon.svg" style="width:30px;height:30px;">
    <p>by Earthen Labs | v0.9</p>
</div>

<script src="js/earthcal-config.js"></script>
<script type="module">
    const parseJwt = (tkn) => {
        try {
            const [, payload] = tkn.split(".");
            return JSON.parse(atob(payload));
        } catch {
            return null;
        }
    };

    const isLoggedIn = () => {
        const token = localStorage.getItem("access_token") || localStorage.getItem("id_token");
        if (!token) return false;
        const payload = parseJwt(token);
        return payload && (!payload.exp || payload.exp > Math.floor(Date.now() / 1000));
    };

    const assets = [
        "js/earthcal-init.js?v=2.1",
        "css/light.css?v7",
        "css/dark.css?v7",
        "css/1-stylesheet.css",
        "fonts/Mulish-Light.ttf",
        "fonts/Mulish-Medium.ttf",
        "fonts/Arvo-Regular.ttf",
        "svgs/up-reg-arrow-dark.svg",
        "svgs/up-reg-arrow-dark-over.svg",
        "svgs/up-reg-arrow-dark-active.svg",
        "svgs/up-reg-arrow-dark-active-hover.svg",
        "svgs/up-reg-arrow-light.svg",
        "svgs/up-reg-arrow-light-over.svg",
        "svgs/up-reg-arrow-light-active.svg",
        "svgs/up-reg-arrow-light-active-hover.svg",
    ];

    const preloadAssets = async () => {
        const bar = document.getElementById("load-progress");
        let loaded = 0;
        const update = () => {
            bar.style.width = `${(loaded / assets.length) * 100}%`;
        };
        await Promise.all(
            assets.map((asset) =>
                fetch(asset)
                    .catch((err) => console.warn("Failed to load", asset, err))
                    .finally(() => {
                        loaded++;
                        update();
                    })
            )
        );
    };

    (async function initApp() {
        const redirectTarget = "dash.html";
        const MIN_WAIT = 2000;
        const startTime = Date.now();

        if (!isLoggedIn()) {
            const defaultProfile = {
                first_name: "Earthling",
                earthling_emoji: "🐸",
                email: null,
                buwana_id: null,
                status: "new",
            };
            sessionStorage.setItem("buwana_user", JSON.stringify(defaultProfile));
        } else {
            const profile = JSON.parse(localStorage.getItem("user_profile") || "null");
            if (profile) {
                sessionStorage.setItem("buwana_user", JSON.stringify(profile));
            }
        }

        if (!navigator.onLine) {
            console.warn("⚠️ Offline. Preloading may fail.");
        }

        await preloadAssets();
        const elapsed = Date.now() - startTime;
        if (elapsed < MIN_WAIT) {
            await new Promise((resolve) => setTimeout(resolve, MIN_WAIT - elapsed));
        }
        window.location.href = redirectTarget;
    })();
</script>
</body>
</html>
