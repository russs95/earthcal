<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Earthcal |  Loading..</title>
    <link rel="icon" href="assets/icons/favicon.ico" />
    <script>
        (function () {
            try {
                const params = new URLSearchParams(window.location.search);
                const buwanaId = params.get("buwana_id") || params.get("id");
                const firstName = params.get("firstname") || params.get("first_name");
                if (buwanaId) {
                    try {
                        localStorage.setItem("buwana_id", buwanaId);
                    } catch (storageError) {
                        console.warn("Unable to store buwana_id in localStorage.", storageError);
                    }
                }

                if (firstName) {
                    window.__EARTHCAL_FIRST_NAME__ = firstName;
                }

                const hasFirstTimeFlag = params.has("firsttime") || params.get("status") === "firsttime";
                window.__EARTHCAL_HAS_FIRST_TIME__ = hasFirstTimeFlag;
                window.__EARTHCAL_BUWANA_ID__ = buwanaId;
            } catch (error) {
                console.error("Unable to process onboarding redirect.", error);
            }
        })();
    </script>
    <link rel="preconnect" href="https://buwana.ecobricks.org" crossorigin>
    <!-- Preload critical dashboard resources ttt-->
    <link rel="preload" href="js/earthcal-init.js?v=2.1" as="script">
    <link rel="preload" href="css/light.css?v7" as="style">
    <link rel="preload" href="css/dark.css?v7" as="style">
    <link rel="preload" href="css/1-stylesheet.css" as="style">
    <link rel="stylesheet" href="css/1-stylesheet.css?v=8.3">
    <link rel="preload" href="assets/fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="assets/fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="assets/fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="svgs/up-reg-arrow-dark.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active-hover.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active-hover.svg" as="image">
    <style>
        :root {
            --general-background: rgb(245, 245, 245);
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Mulish', sans-serif;
            background-color: var(--general-background);
            color: black;
            transition: all 0.3s ease;
            position: relative;
        }
        body.first-time {
            padding: 20px 16px 60px;
        }
        body.first-time-ready {
            justify-content: flex-start;
        }
        body.first-time-ready .earthcal-app-logo {
            margin-top: 12px;
        }
        body.first-time-ready #progress-container {
            display: none;
        }
        body.first-time-ready #onboarding-section {
            display: flex;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --general-background: rgb(13, 15, 26);
            }
            body {
                color: white;
            }
        }
        #progress-container {
            width: 100px;
            height: 10px;
            background-color: #333;
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: none;
        }
        #load-progress {
            width: 0%;
            height: 100%;
            background-color: #ccc;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        @media (prefers-color-scheme: dark) {
            #progress-container {
                background-color: #ccc;
            }
            #load-progress {
                background-color: #333;
            }
        }
        #footer {
            position: absolute;
            bottom: 10px;
            font-size: 0.8em;
            color: grey;
        }
        .earthcal-app-logo,
        .earthcal-app-logo svg {
            width: 120px;
            height: 120px;
        }
        @media screen and (max-width: 768px) {
            body {
                height: 100vh;
            }
            body.first-time {
                padding: 0;
            }
            body.first-time-ready {
                align-items: stretch;
                justify-content: flex-start;
            }
            .earthcal-app-logo,
            .earthcal-app-logo svg {
                width: 180px;
                height: 180px;
            }
            #progress-container {
                width: 150px;
                height: 15px;
            }
            #footer {
                font-size: 1em;
            }
            #footer img {
                width: 40px;
                height: 40px;
            }
            #onboarding-section {
                width: 100vw;
                max-width: none;
                margin: 0;
                border-radius: 0;
                box-shadow: none;
                backdrop-filter: none;
                min-height: 100vh;
                padding: 32px 20px 40px;
                justify-content: flex-start;
                gap: 1.5rem;
            }
            #status-messages {
                flex: 1;
                width: 100%;
            }
        }
        @media screen and (min-width: 769px) and (max-width: 1200px) {
            #onboarding-section {
                width: min(82vw, 640px);
            }
        }
        #onboarding-section {
            display: none;
            width: min(92vw, 640px);
            max-width: 640px;
            margin-top: 24px;
            background: rgba(255, 255, 255, 0.92);
            border-radius: 24px;
            padding: clamp(1.5rem, 5vw, 2.5rem);
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
            flex-direction: column;
            align-items: center;
            gap: clamp(1rem, 4vw, 1.75rem);
            text-align: center;
            color: inherit;
            backdrop-filter: blur(12px);
            overflow-y: auto;
        }
        @media (prefers-color-scheme: dark) {
            #onboarding-section {
                background: rgba(13, 18, 32, 0.85);
                box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35);
            }
        }
        #welcome-message {
            margin: 0;
        }
        #generic-welcome {
            margin: 0;
        }
        #status-messages {
            width: 100%;
        }
        #status-message {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            text-align: left;
        }
        #earthcal-spinner {
            display: inline-flex;
            flex-shrink: 0;
            width: 1.75rem;
            height: 1.75rem;
            border-radius: 50%;
            border: 3px solid rgba(15, 23, 42, 0.15);
            border-top-color: #6c5ce7;
            animation: spin 0.85s linear infinite;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }
        @media (prefers-color-scheme: dark) {
            #earthcal-spinner {
                border-color: rgba(226, 232, 240, 0.25);
                border-top-color: #8ab4ff;
            }
        }
        #earthcal-spinner.spinner-complete {
            animation: none;
            border: none;
            background: transparent;
            width: auto;
            height: auto;
        }
        .status-text {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            font-size: clamp(0.95rem, 2.5vw, 1.05rem);
            color: rgba(15, 23, 42, 0.75);
        }
        .status-text p {
            margin: 0;
        }
        @media (prefers-color-scheme: dark) {
            .status-text {
                color: rgba(226, 232, 240, 0.85);
            }
        }
        #task-log {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }
        #task-log li {
            margin: 0;
        }
        #task-log li.task-log-error {
            color: #b91c1c;
        }
        #get-started-button {
            align-self: center;
            margin-top: 0.5rem;
            padding: 0.85rem 2.75rem;
            font-size: 1rem;
            font-weight: 500;
            color: #f7f9fb;
            background-color: #0d1a26;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease, color 0.2s ease;
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.18);
        }
        #get-started-button[aria-disabled="true"],
        #get-started-button:disabled {
            opacity: 0.55;
            cursor: not-allowed;
            box-shadow: none;
        }
        #get-started-button:not([aria-disabled="true"]):not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.22);
            background-color: #14293a;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
<div class="earthcal-app-logo" style="margin-bottom: 20px;text-align: center;">

    <svg
            width="120px"
            height="120px"
            version="1.1"
            viewBox="0 0 103.23278 103.58668"
            id="svg5"
            sodipodi:docname="earthcal-icon.svg"
            inkscape:version="1.4.2 (2aeb623e1d, 2025-05-12)"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
            xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:svg="http://www.w3.org/2000/svg">
        <sodipodi:namedview
                id="namedview5"
                pagecolor="#ffffff"
                bordercolor="#000000"
                borderopacity="0.25"
                inkscape:showpageshadow="2"
                inkscape:pageopacity="0.0"
                inkscape:pagecheckerboard="0"
                inkscape:deskcolor="#d1d1d1"
                inkscape:document-units="mm"
                inkscape:zoom="1.0395666"
                inkscape:cx="284.73404"
                inkscape:cy="404.49549"
                inkscape:window-width="1033"
                inkscape:window-height="697"
                inkscape:window-x="167"
                inkscape:window-y="32"
                inkscape:window-maximized="0"
                inkscape:current-layer="svg5" />
        <defs
                id="defs1">
            <clipPath
                    id="clipPath5535">
                <path
                        d="m 393.29,-172.81 a 52.077,52.077 0 0 0 -52.077,52.076 52.077,52.077 0 0 0 52.077,52.077 52.077,52.077 0 0 0 52.077,-52.077 52.077,52.077 0 0 0 -52.077,-52.076 z m -1.0583,22.029 a 30.048,30.048 0 0 1 30.048,30.047 30.048,30.048 0 0 1 -30.048,30.048 30.048,30.048 0 0 1 -30.048,-30.048 30.048,30.048 0 0 1 30.048,-30.047 z"
                        fill="#00ffff"
                        stroke-width="0"
                        id="path1" />
            </clipPath>
        </defs>
        <g
                transform="translate(-341.213,172.60604)"
                clip-path="url(#clipPath5535)"
                id="g3">
            <g
                    transform="matrix(0.57548,0,0,0.57548,393.14,-121.3)"
                    stroke-width="0.92194"
                    id="g2">
                <path
                        id="october"
                        d="m -45.782,-77.133 a 90,90 0 0 1 45.225,-12.02 l -0.29047,90 z"
                        fill="#00e6a7" />
                <path
                        id="september"
                        d="m -78.752,-44.219 a 90,90 0 0 1 32.97,-32.915 l 44.934,77.98 z"
                        fill="#00e513" />
                <path
                        id="august"
                        d="m -90.848,0.77143 a 90,90 0 0 1 12.095,-44.989 l 77.904,45.065 z"
                        fill="#beee00" />
                <path
                        d="m -78.827,45.782 a 90,90 0 0 1 -12.02,-45.01 l 90,0.075889 z"
                        fill="#fbfb00"
                        id="path2" />
                <path
                        id="june"
                        d="M -45.914,78.752 A 90,90 0 0 1 -78.829,45.782 L -0.849,0.848 Z"
                        fill="#ffd119" />
                <path
                        id="july"
                        d="m -0.92271,90.847 a 90,90 0 0 1 -44.989,-12.095 l 45.065,-77.904 z"
                        fill="#ff8201" />
                <path
                        id="april"
                        d="m 44.087,78.827 a 90,90 0 0 1 -45.01,12.02 l 0.075889,-90 z"
                        fill="#ff6303" />
                <path
                        id="march"
                        d="M 77.057,45.913 A 90,90 0 0 1 44.087,78.828 L -0.847,0.848 Z"
                        fill="#fb0000" />
                <path
                        id="february"
                        d="m 89.152,0.92271 a 90,90 0 0 1 -12.095,44.989 L -0.847,0.84671 Z"
                        fill="#ff11ce" />
                <path
                        id="january"
                        d="m 77.309,-43.817 c 7.8877,13.688 11.857,28.941 11.844,44.74 l -90,-0.075889 z"
                        fill="#7f2aff" />
                <path
                        id="december"
                        d="m 43.78,-77.057 a 91.197,91.197 0 0 1 33.353,33.408 L -1.884,1.882 Z"
                        fill="#4343ff"
                        stroke-width="0.9342" />
                <path
                        id="november"
                        d="m -0.77143,-89.153 a 90,90 0 0 1 44.989,12.095 l -45.065,77.904 z"
                        fill="#0cacf5" />
            </g>
        </g>
    </svg>

</div>
<div id="progress-container">
    <div id="load-progress"></div>
</div>


<main id="onboarding-section" role="main" hidden>
    <h1 id="welcome-message" class="modal-header">Welcome Earthling</h1>
    <p id="generic-welcome" class="modal-description" hidden>Looks like this could be your first time logging in to EarthCal! Let's get your account setup.</p>
    <div id="status-messages" hidden>
        <div id="status-message">
            <span id="earthcal-spinner" role="status" aria-live="polite" aria-label="Loading"></span>
            <div class="status-text" aria-live="polite">
                <p id="status-intro">We're preparing your personalized EarthCal experience...</p>
                <ul id="task-log" role="log" aria-live="polite" aria-busy="true"></ul>
            </div>
        </div>
    </div>
    <button id="get-started-button" type="button" aria-disabled="true" disabled hidden>Get Started</button>
</main>


<div id="footer" style="text-align: center">
    <img src="svgs/earthen-icon.svg" style="width:30px;height:30px;">
    <p>by Earthen Labs | v0.9</p>
</div>

<script src="js/earthcal-config.js"></script>
<script src="js/first-onboarding.js"></script>
<script type="module">
    const delay = (ms) => new Promise((resolve) => setTimeout(resolve, ms));

    const assets = [
        "js/earthcal-init.js?v=2.1",
        "css/light.css?v7",
        "css/dark.css?v7",
        "css/1-stylesheet.css",
        "fonts/Mulish-Light.ttf",
        "fonts/Mulish-Medium.ttf",
        "fonts/Arvo-Regular.ttf",
        "svgs/up-reg-arrow-dark.svg",
        "svgs/up-reg-arrow-dark-over.svg",
        "svgs/up-reg-arrow-dark-active.svg",
        "svgs/up-reg-arrow-dark-active-hover.svg",
        "svgs/up-reg-arrow-light.svg",
        "svgs/up-reg-arrow-light-over.svg",
        "svgs/up-reg-arrow-light-active.svg",
        "svgs/up-reg-arrow-light-active-hover.svg",
    ];

    const preloadAssets = async () => {
        const bar = document.getElementById("load-progress");
        if (!bar) {
            return;
        }
        let loaded = 0;
        const update = () => {
            bar.style.width = `${(loaded / assets.length) * 100}%`;
        };
        await Promise.all(
            assets.map((asset) =>
                fetch(asset)
                    .catch((err) => console.warn("Failed to load", asset, err))
                    .finally(() => {
                        loaded++;
                        update();
                    })
            )
        );
    };

    const parseJwt = (tkn) => {
        try {
            const [, payload] = tkn.split(".");
            return JSON.parse(atob(payload));
        } catch {
            return null;
        }
    };

    const ensureSessionProfile = () => {
        const defaultProfile = {
            first_name: "Earthling",
            earthling_emoji: "üê∏",
            email: null,
            buwana_id: null,
            status: "new",
        };

        const token = localStorage.getItem("access_token") || localStorage.getItem("id_token");
        if (!token) {
            sessionStorage.setItem("buwana_user", JSON.stringify(defaultProfile));
            return;
        }

        const payload = parseJwt(token);
        const isValid = payload && (!payload.exp || payload.exp > Math.floor(Date.now() / 1000));
        if (!isValid) {
            sessionStorage.setItem("buwana_user", JSON.stringify(defaultProfile));
            return;
        }

        const profile = JSON.parse(localStorage.getItem("user_profile") || "null");
        if (profile) {
            sessionStorage.setItem("buwana_user", JSON.stringify(profile));
        }
    };

    const handleDefaultFlow = async () => {
        const redirectTarget = "dash.html";
        const MIN_WAIT = 2000;
        const MAX_WAIT = 4000;
        const startTime = Date.now();

        ensureSessionProfile();

        if (!navigator.onLine) {
            console.warn("‚ö†Ô∏è Offline. Preloading may fail.");
        }

        let timedOut = false;
        await Promise.race([
            preloadAssets(),
            delay(MAX_WAIT).then(() => {
                timedOut = true;
            }),
        ]);

        if (!timedOut) {
            const elapsed = Date.now() - startTime;
            if (elapsed < MIN_WAIT) {
                await delay(MIN_WAIT - elapsed);
            }
        } else {
            const elapsed = Date.now() - startTime;
            if (elapsed < MIN_WAIT) {
                await delay(MIN_WAIT - elapsed);
            }
        }

        window.location.href = redirectTarget;
    };

    const handleFirstTimeFlow = async () => {
        document.body.classList.add("first-time");
        const bar = document.getElementById("load-progress");
        if (bar) {
            bar.style.transition = "width 2s ease";
            requestAnimationFrame(() => {
                bar.style.width = "100%";
            });
        }

        await delay(2000);

        document.body.classList.add("first-time-ready");

        const onboardingSection = document.getElementById("onboarding-section");
        const genericWelcome = document.getElementById("generic-welcome");
        const statusMessages = document.getElementById("status-messages");
        if (onboardingSection) {
            onboardingSection.removeAttribute("hidden");
        }
        if (genericWelcome) {
            genericWelcome.removeAttribute("hidden");
        }
        if (statusMessages) {
            statusMessages.removeAttribute("hidden");
        }

        await runFirstTimeOnboarding();
    };

    const runFirstTimeOnboarding = async () => {
        const greetingEl = document.getElementById("welcome-message");
        const spinner = document.getElementById("earthcal-spinner");
        const statusIntro = document.getElementById("status-intro");
        const genericWelcome = document.getElementById("generic-welcome");
        const taskLog = document.getElementById("task-log");
        const getStartedButton = document.getElementById("get-started-button");

        const setSpinnerActive = () => {
            if (!spinner) return;
            spinner.classList.remove("spinner-complete");
            spinner.textContent = "";
            spinner.setAttribute("role", "status");
            spinner.setAttribute("aria-label", "Loading");
            spinner.removeAttribute("hidden");
        };

        const setSpinnerComplete = (symbol, ariaLabel) => {
            if (!spinner) return;
            spinner.classList.add("spinner-complete");
            spinner.textContent = symbol;
            spinner.setAttribute("role", "img");
            spinner.setAttribute("aria-label", ariaLabel);
        };

        const normalizeTimeZone = (value) => {
            if (typeof value !== "string") {
                return null;
            }
            const trimmed = value.trim();
            return trimmed.length > 0 ? trimmed : null;
        };

        const toInt = (value) => {
            if (value === null || value === undefined) {
                return null;
            }
            const parsed = Number.parseInt(String(value), 10);
            return Number.isFinite(parsed) && parsed > 0 ? parsed : null;
        };

        const authState = typeof window.isLoggedIn === "function"
            ? window.isLoggedIn({ returnPayload: true })
            : { isLoggedIn: false, payload: null };

        const payload = authState.payload ?? null;
        const profile = window.userProfile ?? null;

        const sanitizeName = (value) => {
            if (typeof value !== "string") {
                return null;
            }
            const trimmed = value.trim();
            return trimmed.length > 0 ? trimmed : null;
        };

        const searchParams = new URLSearchParams(window.location.search);
        const urlFirstName = window.__EARTHCAL_FIRST_NAME__
            || searchParams.get("firstname")
            || searchParams.get("first_name");

        const sanitizedUrlFirstName = sanitizeName(urlFirstName);

        let firstName = sanitizedUrlFirstName || "Earthling";

        const earthlingEmoji = profile?.earthling_emoji
            || payload?.["buwana:earthlingEmoji"]
            || "üåé";

        const buwanaIdValue = window.__EARTHCAL_BUWANA_ID__ || searchParams.get("id") || searchParams.get("buwana_id");
        const buwanaId = toInt(buwanaIdValue);

        const tokenTimeZone = normalizeTimeZone(
            profile?.time_zone
            || payload?.["buwana:timeZone"]
            || payload?.zoneinfo
            || payload?.tzid
            || payload?.time_zone
        );

        const resolvedTimeZone = tokenTimeZone
            || normalizeTimeZone(window.userTimeZone)
            || (() => {
                try {
                    return normalizeTimeZone(Intl.DateTimeFormat().resolvedOptions().timeZone);
                } catch (error) {
                    console.warn("Unable to resolve browser timezone.", error);
                    return null;
                }
            })()
            || "Etc/UTC";

        const defaultCalendarDescription = "Your default, all-purpose personal calendar for general events, to-dos and journals.";

        const updateGreeting = (name) => {
            if (!greetingEl) {
                return;
            }
            const safeName = typeof name === "string" && name.trim().length > 0
                ? name.trim()
                : "Earthling";
            greetingEl.textContent = `Welcome ${safeName}`;
        };

        updateGreeting(firstName);

        if (!buwanaId) {
            console.error("Unable to locate id in the current URL parameters.");
            if (statusIntro) {
                statusIntro.textContent = "We could not confirm your EarthCal account. Please refresh the page to try again.";
            }
            if (spinner) {
                setSpinnerComplete("‚ö†Ô∏è", "Unable to confirm account");
            }
            return;
        }

        try {
            if (typeof window.createJWTloginURL === "function" && getStartedButton) {
                const loginURL = await window.createJWTloginURL();
                if (loginURL) {
                    getStartedButton.setAttribute("aria-disabled", "false");
                    getStartedButton.disabled = false;
                    getStartedButton.removeAttribute("hidden");
                    getStartedButton.addEventListener("click", () => {
                        window.location.href = loginURL;
                    }, { once: true });
                }
            }
        } catch (error) {
            console.error("Unable to generate login URL.", error);
        }

        const subscribeToPublicCalendars = async (userId) => {
            const calendarIds = [52, 53];
            const subscriptionEndpoint = "api/v1/update_pub_cal_subs.php";
            const outcomes = [];
            for (const calendarId of calendarIds) {
                const response = await fetch(subscriptionEndpoint, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        buwana_id: userId,
                        calendar_id: calendarId,
                        subscribe: true,
                    }),
                });

                if (!response.ok) {
                    if (response.status === 409) {
                        outcomes.push({ calendarId, alreadySubscribed: true });
                        continue;
                    }
                    throw new Error(`Subscription request failed with status ${response.status} for calendar ${calendarId}`);
                }

                const json = await response.json();
                if (!json?.ok) {
                    const errorMessage = typeof json?.error === "string" ? json.error.toLowerCase() : "";
                    if (errorMessage.includes("already")) {
                        outcomes.push({ calendarId, alreadySubscribed: true });
                        continue;
                    }
                    throw new Error(json?.error || `Unable to subscribe to calendar ${calendarId}`);
                }

                const alreadySubscribed = Boolean(
                    json?.alreadySubscribed
                    || json?.already_subscribed
                    || json?.alreadyExists
                    || json?.already_exists
                    || json?.status === "existing"
                );

                outcomes.push({
                    calendarId,
                    alreadySubscribed,
                    subscribed: Boolean(json?.subscribed ?? json?.created ?? json?.ok),
                });
            }

            return outcomes;
        };

        const MIN_TASK_DURATION_MS = 4000;

        const runTask = async (label, action) => {
            const list = taskLog;
            let listItem = null;
            const started = performance.now();
            if (list) {
                listItem = document.createElement("li");
                listItem.textContent = `‚è≥ ${label}`;
                list.appendChild(listItem);
            }

            try {
                const result = await action();
                const elapsed = performance.now() - started;
                if (elapsed < MIN_TASK_DURATION_MS) {
                    await delay(MIN_TASK_DURATION_MS - elapsed);
                }
                if (listItem) {
                    listItem.textContent = `‚úÖ ${label}`;
                }
                return { result, listItem };
            } catch (taskError) {
                const elapsed = performance.now() - started;
                if (elapsed < MIN_TASK_DURATION_MS) {
                    await delay(MIN_TASK_DURATION_MS - elapsed);
                }
                if (listItem) {
                    listItem.textContent = `‚ö†Ô∏è ${label}`;
                }
                throw taskError;
            }
        };

        const addAnniversaryEvent = async ({ userId, calendarId, tzid }) => {
            if (!userId || !calendarId) {
                throw new Error("Missing calendar context for the anniversary event.");
            }

            const safeTzid = tzid || "Etc/UTC";
            const todayInTz = (() => {
                try {
                    const formatter = new Intl.DateTimeFormat("en-CA", {
                        timeZone: safeTzid,
                        year: "numeric",
                        month: "2-digit",
                        day: "2-digit",
                    });
                    return formatter.format(new Date());
                } catch (error) {
                    console.warn("Falling back to UTC for anniversary event formatting.", error);
                    return new Date().toISOString().slice(0, 10);
                }
            })();

            const payload = {
                buwana_id: userId,
                calendar_id: calendarId,
                item_kind: "event",
                title: "EarthCal Anniversary",
                notes: "You joined Earthcal on this day! Celebrating your transition from linear-time to cycle-time.",
                start_local: `${todayInTz} 00:00:00`,
                tzid: safeTzid,
                all_day: true,
                emoji: "üéâ",
            };

            const response = await fetch("api/v1/add_item.php", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                credentials: "same-origin",
                body: JSON.stringify(payload),
            });

            if (!response.ok) {
                if (response.status === 409) {
                    return { alreadyExists: true };
                }
                throw new Error(`Anniversary event creation failed with status ${response.status}`);
            }

            const json = await response.json();
            if (!json?.ok) {
                const errorMessage = typeof json?.error === "string" ? json.error.toLowerCase() : "";
                if (errorMessage.includes("already")) {
                    return { alreadyExists: true };
                }
                throw new Error(json?.error || "Unable to add the anniversary event.");
            }

            const alreadyExists = Boolean(
                json?.alreadyExists
                || json?.already_exists
                || json?.status === "existing"
            );

            return {
                alreadyExists,
                created: Boolean(json?.created ?? json?.ok),
            };
        };

        try {
            setSpinnerActive();
            if (statusIntro) {
                statusIntro.textContent = "We are setting up your personalized calendars...";
            }

            let userTimeZone = resolvedTimeZone;
            let calendarId = null;
            let myCalendarCreated = false;
            let calendarTimeZone = resolvedTimeZone;
            const hasTokenTimeZone = Boolean(tokenTimeZone);

            const { result: accountCheckJson, listItem: confirmTaskItem } = await runTask("Confirming your EarthCal account", async () => {
                const checkResponse = await fetch("api/v1/create_my_calendar.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({ buwana_id: buwanaId, check_only: true }),
                });

                if (!checkResponse.ok) {
                    throw new Error(`User confirmation failed with status ${checkResponse.status}`);
                }

                const checkJson = await checkResponse.json();
                if (!checkJson?.ok || !checkJson?.exists) {
                    throw new Error("User not located in users_tb.");
                }
                console.log(`‚úÖ Confirmed EarthCal account in users_tb for buwana_id ${buwanaId}.`, checkJson.user ?? {});
                if (!hasTokenTimeZone && checkJson?.user?.time_zone) {
                    userTimeZone = checkJson.user.time_zone;
                }
                const fetchedFirstName = checkJson?.user?.first_name
                    || checkJson?.user?.firstName
                    || checkJson?.user?.given_name;
                const sanitizedFetchedFirstName = sanitizeName(fetchedFirstName);
                if (!sanitizedUrlFirstName && sanitizedFetchedFirstName) {
                    firstName = sanitizedFetchedFirstName;
                    updateGreeting(firstName);
                }
                return checkJson;
            });

            if (confirmTaskItem) {
                const alreadyExisting = Boolean(accountCheckJson?.exists);
                confirmTaskItem.textContent = alreadyExisting
                    ? "‚úÖ Confirmed your EarthCal account details"
                    : "‚úÖ Created your EarthCal account details";
            }

            const { listItem: calendarTaskItem } = await runTask("Setting up your My Calendar", async () => {
                const createResponse = await fetch("api/v1/create_my_calendar.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    credentials: "same-origin",
                    body: JSON.stringify({
                        buwana_id: buwanaId,
                        emoji: earthlingEmoji,
                        tzid: userTimeZone,
                        description: defaultCalendarDescription,
                    }),
                });

                if (!createResponse.ok) {
                    throw new Error(`Calendar creation failed with status ${createResponse.status}`);
                }

                const createJson = await createResponse.json();
                if (!createJson?.ok) {
                    throw new Error(createJson?.error || "Unknown error while creating My Calendar");
                }

                console.log("üìÖ My Calendar status:", createJson);
                const calendar = createJson.calendar ?? null;
                const potentialId = calendar?.calendar_id ?? calendar?.calendarId ?? calendar?.id;
                const parsedId = typeof potentialId === "string" || typeof potentialId === "number"
                    ? Number(potentialId)
                    : null;
                if (Number.isFinite(parsedId)) {
                    calendarId = parsedId;
                }
                myCalendarCreated = Boolean(createJson.created);
                calendarTimeZone = calendar?.tzid || userTimeZone || resolvedTimeZone || "Etc/UTC";
                return createJson;
            });

            if (calendarTaskItem) {
                calendarTaskItem.textContent = myCalendarCreated
                    ? "‚úÖ Created your My Calendar"
                    : "‚úÖ Your My Calendar was already set up";
            }

            const { result: subscriptionResults, listItem: subscriptionTaskItem } = await runTask(
                "Ensuring the 2025 and 2026 Astrological Events calendars are enabled",
                async () => subscribeToPublicCalendars(buwanaId)
            );

            if (subscriptionTaskItem) {
                const alreadyEnabled = Array.isArray(subscriptionResults)
                    && subscriptionResults.length > 0
                    && subscriptionResults.every((entry) => entry?.alreadySubscribed);
                subscriptionTaskItem.textContent = alreadyEnabled
                    ? "‚úÖ Astrological Events calendars were already enabled"
                    : "‚úÖ Enabled the 2025 and 2026 Astrological Events calendars";
            }

            const { result: anniversaryResult, listItem: anniversaryTaskItem } = await runTask(
                "Ensuring your üéâ EarthCal Anniversary celebration is scheduled",
                async () => addAnniversaryEvent({
                    userId: buwanaId,
                    calendarId,
                    tzid: calendarTimeZone || userTimeZone,
                })
            );

            if (anniversaryTaskItem) {
                anniversaryTaskItem.textContent = anniversaryResult?.alreadyExists
                    ? "‚úÖ Your EarthCal Anniversary celebration was already scheduled"
                    : "‚úÖ Added your EarthCal Anniversary celebration";
            }

            if (taskLog) {
                taskLog.setAttribute("aria-busy", "false");
            }

            const completionMessage = myCalendarCreated
                ? "Your My Calendar is ready, the Astrological Events calendars are enabled, and your EarthCal Anniversary celebration is on the books for our beta checks. Click below to get started."
                : "Your My Calendar was already waiting for you, so we re-confirmed your Astrological Events calendars and Anniversary celebration for beta testing‚Äîeverything is ready to explore!";

            if (spinner) {
                setSpinnerComplete("", "Onboarding complete");
                spinner.removeAttribute("aria-label");
                spinner.removeAttribute("role");
                spinner.setAttribute("hidden", "");
            }

            if (statusIntro) {
                statusIntro.textContent = "";
                statusIntro.setAttribute("hidden", "");
            }

            if (genericWelcome) {
                genericWelcome.textContent = completionMessage;
            }
        } catch (error) {
            console.error("Unable to complete onboarding steps.", error);
            if (statusIntro) {
                statusIntro.textContent = "We ran into a hiccup preparing your account. Please refresh the page to try again.";
            }
            if (spinner) {
                setSpinnerComplete("‚ö†Ô∏è", "An error occurred");
            }
            if (taskLog) {
                taskLog.setAttribute("aria-busy", "false");
                const errorItem = document.createElement("li");
                errorItem.textContent = error instanceof Error ? `Details: ${error.message}` : "An unexpected error occurred.";
                errorItem.classList.add("task-log-error");
                taskLog.appendChild(errorItem);
            }
        }
    };

    (async function initApp() {
        const hasFirstTimeFlag = Boolean(window.__EARTHCAL_HAS_FIRST_TIME__);
        if (hasFirstTimeFlag) {
            await handleFirstTimeFlow();
        } else {
            await handleDefaultFlow();
        }
    })();
</script>
</body>
</html>
