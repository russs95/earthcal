<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Earthcal Entry</title>
    <link rel="icon" href="/icons/favicon.ico">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            background-color: white;
            color: black;
            transition: all 0.3s ease;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #111;
                color: white;
            }
        }
        h3 {
            font-size: 1.5em;
            text-align: center;
        }
    </style>
</head>
<body>
<h3>üå± Preparing Earthcal<span id="dots">...</span></h3>

<script>
    const parseJwt = (tkn) => {
        try {
            const [, payload] = tkn.split('.');
            return JSON.parse(atob(payload));
        } catch (e) {
            console.warn("Couldn't decode JWT:", e);
            return null;
        }
    };

    function getBuwanaIdFromStorage() {
        const sources = [
            localStorage.getItem("user_profile"),
            localStorage.getItem("id_token") && parseJwt(localStorage.getItem("id_token")),
            localStorage.getItem("access_token") && parseJwt(localStorage.getItem("access_token"))
        ];

        for (const item of sources) {
            if (!item) continue;
            try {
                const profile = typeof item === 'string' ? JSON.parse(item) : item;
                if (profile?.buwana_id) {
                    const now = Math.floor(Date.now() / 1000);
                    if (profile.exp && profile.exp < now) {
                        console.warn("üö´ Token expired for buwana_id:", profile.buwana_id);
                        return { buwanaId: null, profile: null };
                    }
                    console.log("‚úÖ Valid buwana_id from profile:", profile.buwana_id);
                    return { buwanaId: profile.buwana_id, profile };
                }
            } catch (e) {
                console.warn("Failed to parse profile/token:", e);
            }
        }

        console.warn("‚ùå No valid buwana_id found in storage.");
        return { buwanaId: null, profile: null };
    }

    let dotPhase = 0;
    const dotElem = document.getElementById("dots");
    setInterval(() => {
        dotPhase = (dotPhase + 1) % 4;
        dotElem.textContent = ".".repeat(dotPhase);
    }, 400);

    (async function initApp() {
        const redirectTarget = "dash.html";

        if (!navigator.onLine) {
            console.warn("‚ö†Ô∏è Offline. Redirecting to:", redirectTarget);
            window.location.href = redirectTarget;
            return;
        }

        const { buwanaId, profile } = getBuwanaIdFromStorage();

        if (profile) {
            sessionStorage.setItem("buwana_user", JSON.stringify(profile));
        }

        if (!buwanaId) {
            console.warn("No valid buwana_id. Skipping fetch and redirecting.");
            window.location.href = redirectTarget;
            return;
        }

        if (!sessionStorage.getItem("user_calendars")) {
            try {
                console.log("üì° Fetching calendars for buwana_id:", buwanaId);
                const calRes = await fetch("https://buwana.ecobricks.org/earthcal/fetch_all_calendars.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ buwana_id: buwanaId })
                });
                const calData = await calRes.json();
                if (calData.success) {
                    console.log("‚úÖ Retrieved calendar data:", calData);
                    sessionStorage.setItem("user_calendars", JSON.stringify(calData));
                } else {
                    console.warn("‚ö†Ô∏è Calendar fetch failed:", calData.message);
                }
            } catch (e) {
                console.error("‚ö†Ô∏è Error fetching calendars:", e);
            }
        } else {
            console.log("üóÉÔ∏è Using cached user_calendars from sessionStorage");
        }

        window.location.href = redirectTarget;
    })();
</script>
</body>
</html>