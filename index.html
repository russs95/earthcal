<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Earthcal |  Loading...</title>
    <link rel="icon" href="icons/favicon.ico" />
    <link rel="preconnect" href="https://buwana.ecobricks.org" crossorigin>
    <!-- Preload critical dashboard resources -->
    <link rel="preload" href="js/earthcal-init.js" as="script">
    <link rel="preload" href="css/light.css" as="style">
    <link rel="preload" href="css/dark.css" as="style">
    <link rel="preload" href="css/1-stylesheet.css" as="style">
    <link rel="preload" href="fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="svgs/up-reg-arrow-dark.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active-hover.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active-hover.svg" as="image">
    <style>
        :root {
            --general-background: rgb(245, 245, 245);
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            background-color: var(--general-background);
            color: black;
            transition: all 0.3s ease;
            position: relative;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --general-background: rgb(13, 15, 26);
            }
            body {
                color: white;
            }
        }
        #progress-container {
            width: 250px;
            height: 20px;
            background-color: #333;
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
        }
        #load-progress {
            width: 0%;
            height: 100%;
            background-color: #ccc;
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        @media (prefers-color-scheme: dark) {
            #progress-container {
                background-color: #ccc;
            }
            #load-progress {
                background-color: #333;
            }
        }
        #footer {
            position: absolute;
            bottom: 10px;
            font-size: 0.8em;
            color: grey;
        }
    </style>
</head>
<body>
<div class="earthcal-app-logo" style="margin-bottom: 20px;"><img src="svgs/earthcal-icon.svg" style="width:125px;height:125px;"></div>
<div id="progress-container"><div id="load-progress"></div></div>
<div id="footer">Earthcal is developed by Earthen Labs.</div>

<script type="module">
    const parseJwt = (tkn) => {
        try {
            const [, payload] = tkn.split(".");
            return JSON.parse(atob(payload));
        } catch {
            return null;
        }
    };

    const isLoggedIn = () => {
        const token = localStorage.getItem("access_token") || localStorage.getItem("id_token");
        if (!token) return false;
        const payload = parseJwt(token);
        return payload && (!payload.exp || payload.exp > Math.floor(Date.now() / 1000));
    };

    const assets = [
        "js/earthcal-init.js",
        "css/light.css",
        "css/dark.css",
        "css/1-stylesheet.css",
        "fonts/Mulish-Light.ttf",
        "fonts/Mulish-Medium.ttf",
        "fonts/Arvo-Regular.ttf",
        "svgs/up-reg-arrow-dark.svg",
        "svgs/up-reg-arrow-dark-over.svg",
        "svgs/up-reg-arrow-dark-active.svg",
        "svgs/up-reg-arrow-dark-active-hover.svg",
        "svgs/up-reg-arrow-light.svg",
        "svgs/up-reg-arrow-light-over.svg",
        "svgs/up-reg-arrow-light-active.svg",
        "svgs/up-reg-arrow-light-active-hover.svg",
    ];

    const preloadAssets = async () => {
        const bar = document.getElementById("load-progress");
        let loaded = 0;
        const update = () => {
            bar.style.width = `${(loaded / assets.length) * 100}%`;
        };
        await Promise.all(
            assets.map((asset) =>
                fetch(asset)
                    .catch((err) => console.warn("Failed to load", asset, err))
                    .finally(() => {
                        loaded++;
                        update();
                    })
            )
        );
    };

    (async function initApp() {
        const redirectTarget = "dash.html";
        const MIN_WAIT = 2000;
        const startTime = Date.now();

        if (!isLoggedIn()) {
            const defaultProfile = {
                first_name: "Earthling",
                earthling_emoji: "üê∏",
                email: null,
                buwana_id: null,
                status: "new",
            };
            sessionStorage.setItem("buwana_user", JSON.stringify(defaultProfile));
        } else {
            const profile = JSON.parse(localStorage.getItem("user_profile") || "null");
            if (profile) {
                sessionStorage.setItem("buwana_user", JSON.stringify(profile));
            }
        }

        if (!navigator.onLine) {
            console.warn("‚ö†Ô∏è Offline. Preloading may fail.");
        }

        await preloadAssets();
        const elapsed = Date.now() - startTime;
        if (elapsed < MIN_WAIT) {
            await new Promise((resolve) => setTimeout(resolve, MIN_WAIT - elapsed));
        }
        window.location.href = redirectTarget;
    })();
</script>
</body>
</html>
