<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Earthcal |  Loading...</title>
    <link rel="icon" href="icons/favicon.ico" />
    <link rel="preconnect" href="https://buwana.ecobricks.org" crossorigin>
    <!-- Preload critical dashboard resources -->
    <link rel="preload" href="js/earthcal-init.js" as="script">
    <link rel="preload" href="css/light.css" as="style">
    <link rel="preload" href="css/dark.css" as="style">
    <link rel="preload" href="css/1-stylesheet.css" as="style">
    <link rel="preload" href="fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="svgs/up-reg-arrow-dark.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-dark-active-hover.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-over.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active.svg" as="image">
    <link rel="preload" href="svgs/up-reg-arrow-light-active-hover.svg" as="image">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            background-color: white;
            color: black;
            transition: all 0.3s ease;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #111;
                color: white;
            }
        }
        #spinner {
            font-size: 3.5em;
        }
        h3 {
            font-size: 0.9em;
            color: grey;
            text-align: center;
        }
    </style>
</head>
<body>
<div class="earthcal-app-logo" style="margin-bottom: 20px;"><img src="svgs/earthcal-icon.svg" style="width:125px;height:125px;"></div>
<div id="spinner" aria-hidden="true">üåë</div>
<h3>Loading Earthcal<span id="dots">...</span></h3>

<script type="module">
    const parseJwt = (tkn) => {
        try {
            const [, payload] = tkn.split(".");
            return JSON.parse(atob(payload));
        } catch {
            return null;
        }
    };

    const isLoggedIn = () => {
        const token = localStorage.getItem("access_token") || localStorage.getItem("id_token");
        if (!token) return false;
        const payload = parseJwt(token);
        return payload && (!payload.exp || payload.exp > Math.floor(Date.now() / 1000));
    };

    const dotElem = document.getElementById("dots");
    let dotPhase = 0;
    setInterval(() => {
        dotPhase = (dotPhase + 1) % 4;
        dotElem.textContent = ".".repeat(dotPhase);
    }, 400);

    const spinner = document.getElementById("spinner");
    const phases = ["üåë", "üåí", "üåì", "üåî", "üåï", "üåñ", "üåó", "üåò"];
    let phaseIndex = 0;
    setInterval(() => {
        spinner.textContent = phases[phaseIndex];
        phaseIndex = (phaseIndex + 1) % phases.length;
    }, 200);

    (async function initApp() {
        const redirectTarget = "dash.html";

        if (!navigator.onLine) {
            console.warn("‚ö†Ô∏è Offline. Redirecting to:", redirectTarget);
            window.location.href = redirectTarget;
            return;
        }

        if (!isLoggedIn()) {
            const defaultProfile = {
                first_name: "Earthling",
                earthling_emoji: "üê∏",
                email: null,
                buwana_id: null,
                status: "new"
            };
            sessionStorage.setItem("buwana_user", JSON.stringify(defaultProfile));
            window.location.href = redirectTarget;
            return;
        }

        const profile = JSON.parse(localStorage.getItem("user_profile") || "null");
        if (profile) {
            sessionStorage.setItem("buwana_user", JSON.stringify(profile));
        }

        window.location.href = redirectTarget;
    })();
</script>
</body>
</html>
