<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Earthcal Entry</title>
    <link rel="icon" href="/icons/favicon.ico">
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            background-color: white;
            color: black;
            transition: all 0.3s ease;
        }
        @media (prefers-color-scheme: dark) {
            body {
                background-color: #111;
                color: white;
            }
        }
        h3 {
            font-size: 1.5em;
            text-align: center;
        }
    </style>
</head>
<body>
<h3>üå± Preparing Earthcal<span id="dots">...</span></h3>

<script src="https://cdn.jsdelivr.net/npm/jwt-decode@3.1.2/build/jwt-decode.min.js"></script>
<script>
    // Animate dots for spinner effect
    let dotPhase = 0;
    const dotElem = document.getElementById("dots");
    setInterval(() => {
        dotPhase = (dotPhase + 1) % 4;
        dotElem.textContent = ".".repeat(dotPhase);
    }, 400);

    async function initApp() {
        const redirectTarget = "dashboard.html";

        if (!navigator.onLine) {
            alert(`You are offline. Redirecting to: ${redirectTarget}`);
            window.location.href = redirectTarget;
            return;
        }

        let buwanaId = null;

        try {
            const token = localStorage.getItem("buwana_token");
            if (!token) throw new Error("No token found");

            const decoded = jwt_decode(token);
            buwanaId = decoded?.buwana_id;
            if (!buwanaId) throw new Error("No buwana_id in token");

            const res = await fetch("https://buwana.ecobricks.org/api/userinfo.php", {
                headers: {
                    Authorization: `Bearer ${token}`
                }
            });

            if (res.ok) {
                const user = await res.json();
                console.log("‚úÖ Retrieved user:", user);
                sessionStorage.setItem("buwana_user", JSON.stringify(user));
            }
        } catch (e) {
            console.warn("‚ö†Ô∏è Auth check failed:", e);
        }

        // Fetch calendars
        if (buwanaId) {
            try {
                const calRes = await fetch("https://buwana.ecobricks.org/earthcal/fetch_all_calendars.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ buwana_id: buwanaId })
                });

                const calData = await calRes.json();
                if (calData.success) {
                    console.log("‚úÖ Retrieved calendar data:", calData);
                    sessionStorage.setItem("user_calendars", JSON.stringify(calData));
                } else {
                    console.warn("‚ö†Ô∏è Calendar fetch failed:", calData.message);
                }
            } catch (e) {
                console.error("‚ö†Ô∏è Error fetching calendars:", e);
            }
        }

        alert(`Redirecting to: ${redirectTarget}`);
        window.location.href = redirectTarget;
    }

    initApp();
</script>
</body>
</html>
