<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Earthcal | Loading..</title>
    <link rel="icon" href="/assets/icons/favicon.ico" />
    <link rel="preconnect" href="https://buwana.ecobricks.org" crossorigin>
    <link rel="preload" href="/js/earthcal-init.js?v=2.1" as="script">
    <link rel="preload" href="/css/light.css?v7" as="style">
    <link rel="preload" href="/css/dark.css?v7" as="style">
    <link rel="preload" href="/css/1-stylesheet.css" as="style">
    <link rel="preload" href="/assets/fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="/assets/fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="/assets/fonts/Arvo-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="/svgs/up-reg-arrow-dark.svg" as="image">
    <link rel="preload" href="/svgs/up-reg-arrow-dark-over.svg" as="image">
    <link rel="preload" href="/svgs/up-reg-arrow-dark-active.svg" as="image">
    <link rel="preload" href="/svgs/up-reg-arrow-dark-active-hover.svg" as="image">
    <link rel="preload" href="/svgs/up-reg-arrow-light.svg" as="image">
    <link rel="preload" href="/svgs/up-reg-arrow-light-over.svg" as="image">
    <link rel="preload" href="/svgs/up-reg-arrow-light-active.svg" as="image">
    <link rel="preload" href="/svgs/up-reg-arrow-light-active-hover.svg" as="image">
    <style>
        :root {
            --general-background: rgb(245, 245, 245);
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            font-family: 'Arial', sans-serif;
            background-color: var(--general-background);
            color: black;
            transition: all 0.3s ease;
            position: relative;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --general-background: rgb(13, 15, 26);
            }
            body {
                color: white;
            }
        }
        #progress-container {
            width: 100px;
            height: 10px;
            margin-top: 10px;
            border-radius: 10px;
            overflow: hidden;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
        }
        #load-progress {
            display: none;
        }
        #authenticating-text {
            height: 100%;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            font-size: 0.65rem;
            line-height: 10px;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            color: inherit;
        }
        #authenticating-text span {
            white-space: nowrap;
        }
        #dots {
            display: inline-block;
            min-width: 0.9em;
            text-align: left;
        }
        @media (prefers-color-scheme: dark) {
            #progress-container {
                background-color: transparent;
            }
        }
        #footer {
            position: absolute;
            bottom: 10px;
            font-size: 0.8em;
            color: grey;
            text-align: center;
        }
        .earthcal-app-logo,
        .earthcal-app-logo svg {
            width: 120px;
            height: 120px;
        }
        @media screen and (max-width: 768px) {
            .earthcal-app-logo,
            .earthcal-app-logo svg {
                width: 180px;
                height: 180px;
            }
            #progress-container {
                width: 150px;
                height: 15px;
            }
            #authenticating-text {
                font-size: 0.8rem;
                line-height: 15px;
            }
            #footer {
                font-size: 1em;
            }
            #footer img {
                width: 40px;
                height: 40px;
            }
        }
    </style>
</head>
<body>
<div class="earthcal-app-logo" style="margin-bottom: 20px;text-align: center;">

    <svg
            width="120px"
            height="120px"
            version="1.1"
            viewBox="0 0 103.23278 103.58668"
            id="svg5"
            sodipodi:docname="earthcal-icon.svg"
            inkscape:version="1.4.2 (2aeb623e1d, 2025-05-12)"
            xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
            xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:svg="http://www.w3.org/2000/svg">
        <sodipodi:namedview
                id="namedview5"
                pagecolor="#ffffff"
                bordercolor="#000000"
                borderopacity="0.25"
                inkscape:showpageshadow="2"
                inkscape:pageopacity="0.0"
                inkscape:pagecheckerboard="0"
                inkscape:deskcolor="#d1d1d1"
                inkscape:document-units="mm"
                inkscape:zoom="1.0395666"
                inkscape:cx="284.73404"
                inkscape:cy="404.49549"
                inkscape:window-width="1033"
                inkscape:window-height="697"
                inkscape:window-x="167"
                inkscape:window-y="32"
                inkscape:window-maximized="0"
                inkscape:current-layer="svg5" />
        <defs
                id="defs1">
            <clipPath
                    id="clipPath5535">
                <path
                        d="m 393.29,-172.81 a 52.077,52.077 0 0 0 -52.077,52.076 52.077,52.077 0 0 0 52.077,52.077 52.077,52.077 0 0 0 52.077,-52.077 52.077,52.077 0 0 0 -52.077,-52.076 z m -1.0583,22.029 a 30.048,30.048 0 0 1 30.048,30.047 30.048,30.048 0 0 1 -30.048,30.048 30.048,30.048 0 0 1 -30.048,-30.048 30.048,30.048 0 0 1 30.048,-30.047 z"
                        fill="#00ffff"
                        stroke-width="0"
                        id="path1" />
            </clipPath>
        </defs>
        <g
                transform="translate(-341.213,172.60604)"
                clip-path="url(#clipPath5535)"
                id="g3">
            <g
                    transform="matrix(0.57548,0,0,0.57548,393.14,-121.3)"
                    stroke-width="0.92194"
                    id="g2">
                <path
                        id="october"
                        d="m -45.782,-77.133 a 90,90 0 0 1 45.225,-12.02 l -0.29047,90 z"
                        fill="#00e6a7" />
                <path
                        id="september"
                        d="m -78.752,-44.219 a 90,90 0 0 1 32.97,-32.915 l 44.934,77.98 z"
                        fill="#00e513" />
                <path
                        id="august"
                        d="m -90.848,0.77143 a 90,90 0 0 1 12.095,-44.989 l 77.904,45.065 z"
                        fill="#beee00" />
                <path
                        d="m -78.827,45.782 a 90,90 0 0 1 -12.02,-45.01 l 90,0.075889 z"
                        fill="#fbfb00"
                        id="path2" />
                <path
                        id="june"
                        d="M -45.914,78.752 A 90,90 0 0 1 -78.829,45.782 L -0.849,0.848 Z"
                        fill="#ffd119" />
                <path
                        id="july"
                        d="m -0.92271,90.847 a 90,90 0 0 1 -44.989,-12.095 l 45.065,-77.904 z"
                        fill="#ff8201" />
                <path
                        id="april"
                        d="m 44.087,78.827 a 90,90 0 0 1 -45.01,12.02 l 0.075889,-90 z"
                        fill="#ff6303" />
                <path
                        id="march"
                        d="M 77.057,45.913 A 90,90 0 0 1 44.087,78.828 L -0.847,0.848 Z"
                        fill="#fb0000" />
                <path
                        id="february"
                        d="m 89.152,0.92271 a 90,90 0 0 1 -12.095,44.989 L -0.847,0.84671 Z"
                        fill="#ff11ce" />
                <path
                        id="january"
                        d="m 77.309,-43.817 c 7.8877,13.688 11.857,28.941 11.844,44.74 l -90,-0.075889 z"
                        fill="#7f2aff" />
                <path
                        id="december"
                        d="m 43.78,-77.057 a 91.197,91.197 0 0 1 33.353,33.408 L -1.884,1.882 Z"
                        fill="#4343ff"
                        stroke-width="0.9342" />
                <path
                        id="november"
                        d="m -0.77143,-89.153 a 90,90 0 0 1 44.989,12.095 l -45.065,77.904 z"
                        fill="#0cacf5" />
            </g>
        </g>
    </svg>

</div>
<div id="progress-container">
    <div id="load-progress"></div>
    <div id="authenticating-text" role="status" aria-live="polite">
        <span>Authenticating with Buwana</span>
        <span id="dots">...</span>
    </div>
</div>

<div id="footer">
    <img src="/svgs/earthen-icon.svg" style="width:30px;height:30px;" alt="Earthen Labs logo">
    <p>by Earthen Labs | v0.9</p>
</div>

<script>
    // Animate dots
    let dotPhase = 0;
    const dotElem = document.getElementById("dots");
    setInterval(() => {
        dotPhase = (dotPhase % 3) + 1;
        dotElem.textContent = ".".repeat(dotPhase);
    }, 400);

    (async function() {
        // 🛠️ Some providers incorrectly append query parameters using '?' instead of '&'.
        //    Normalize the query string so code and state can be parsed reliably.
        let search = window.location.search;
        if ((search.match(/\?/g) || []).length > 1) {
            const parts = search.split('?');
            search = '?' + parts.slice(1).join('&');
            const newUrl = window.location.pathname + search + window.location.hash;
            window.history.replaceState({}, '', newUrl);
        }

        const urlParams = new URLSearchParams(search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");
        const status = urlParams.get("status");

        if (!code || !state) {
            console.error("Missing code or state in callback");
            alert("Login failed: missing parameters.");
            return;
        }

        const storedState = sessionStorage.getItem("oidc_state");
        if (state !== storedState) {
            console.error("State mismatch.");
            alert("Login failed: invalid state.");
            return;
        }

        const codeVerifier = sessionStorage.getItem("pkce_code_verifier");
        if (!codeVerifier) {
            console.error("Missing code_verifier");
            alert("Login failed: missing code_verifier.");
            return;
        }

        try {
            const tokenResponse = await fetch("https://buwana.ecobricks.org/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    grant_type: "authorization_code",
                    code: code,
                    redirect_uri: "https://earthcal.app/auth/callback",
                    client_id: "ecal_7f3da821d0a54f8a9b58",
                    code_verifier: codeVerifier
                })
            });

            if (!tokenResponse.ok) throw new Error("Token exchange failed");

            const tokenData = await tokenResponse.json();

            if (!tokenData.id_token || !tokenData.access_token) {
                throw new Error("Missing tokens in response");
            }

            const idPayload = JSON.parse(atob(tokenData.id_token.split('.')[1]));
            console.log("ID Token Payload:", idPayload);

            const supportedLangs = ['en','es','id','fr','zh','ar','de'];
            let lang = (navigator.language || 'en').slice(0,2).toLowerCase();
            if (!supportedLangs.includes(lang)) lang = 'en';

            const checkResp = await fetch(
                `https://buwana.ecobricks.org/api/check_user_app_connection.php?buwana_id=${idPayload.buwana_id}&client_id=ecal_7f3da821d0a54f8a9b58`,
                { credentials: 'include' }
            );
            let checkData = null;
            try {
                checkData = await checkResp.clone().json();
            } catch (parseErr) {
                console.warn('Connection check response not JSON', parseErr);
            }

            if (checkResp.redirected) {
                window.location.href = checkResp.url;
                return;
            }
            if (!checkResp.ok || !checkData || checkData.connected !== true) {
                const connectUrl =
                    (checkData && checkData.app_login_url)
                        ? checkData.app_login_url
                        : `https://buwana.ecobricks.org/${lang}/app-connect.php?id=${idPayload.buwana_id}&client_id=ecal_7f3da821d0a54f8a9b58`;
                window.location.href = connectUrl;
                return;
            }

            localStorage.setItem("id_token", tokenData.id_token);
            localStorage.setItem("access_token", tokenData.access_token);
            localStorage.setItem("token_type", tokenData.token_type);
            localStorage.setItem("expires_in", tokenData.expires_in);
            localStorage.setItem("user_profile", JSON.stringify(idPayload));

            sessionStorage.removeItem("pkce_code_verifier");
            sessionStorage.removeItem("oidc_state");
            sessionStorage.removeItem("oidc_nonce");

            window.history.replaceState({}, document.title, "/auth/callback");

            let redirectUrl = "/index.html";
            if (status) {
                redirectUrl += `?status=${encodeURIComponent(status)}`;
            }
            window.location.href = redirectUrl;

        } catch (err) {
            console.error("Authentication error:", err);
            alert("Login failed. Please try again.");
        }
    })();
</script>
</body>
</html>
