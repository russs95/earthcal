<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Earthcal | Authenticating..</title>
    <link rel="icon" href="/assets/icons/favicon.ico" />
    <link rel="preconnect" href="https://buwana.ecobricks.org" crossorigin>
<!--    <link rel="preload" href="/js/earthcal-init.js?v=2.1" as="script">-->
<!--    <link rel="preload" href="/css/1-stylesheet.css" as="style">-->
    <link rel="preload" href="https://earthcal.app/css/light.css?v7" as="style">
    <link rel="preload" href="https://earthcal.app/css/dark.css?v7" as="style">

    <link rel="preload" href="https://earthcal.app/assets/fonts/Mulish-Light.ttf" as="font" type="font/ttf" crossorigin="anonymous">
    <link rel="preload" href="https://earthcal.app/assets/fonts/Mulish-Medium.ttf" as="font" type="font/ttf" crossorigin="anonymous">

    <style>
        :root {
            --general-background: rgb(245, 245, 245);
            --emblem-green: #008000;
            --emblem-green-over: #0ca70c;
        }
        html,
        body {
            height: 100%;
        }
        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            font-family: 'Mulish', sans-serif;
            background-color: var(--general-background);
            background-image: url('/webp/earthen-subscription-background-light.webp');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            color: black;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        body.theme-dark {
            --general-background: rgb(13, 15, 26);
            --emblem-green: #2b6d27;
            --emblem-green-over: #41a43c;
            color: #f8fafc;
            background-color: var(--general-background);
            background-image: url('/webp/earthen-subscription-background-dark.webp');
        }
        body.theme-dark .footer {
            color: rgba(226, 232, 240, 0.75);
        }
        body.theme-dark #authenticating-text {
            color: #e2e8f0;
        }
        #initial-load {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 24px 16px 60px;
            box-sizing: border-box;
            gap: 18px;
        }
        .earthcal-logo {
            width: 120px;
            max-width: 100%;
            height: auto;
            display: block;
        }
        #authenticating-text {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: clamp(0.9rem, 3vw, 1.05rem);
            letter-spacing: 0.04em;
        }
        #authenticating-text span {
            white-space: nowrap;
        }
        #dots {
            display: inline-block;
            min-width: 0.9em;
            text-align: left;
        }
        .footer {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
            color: grey;
            z-index: 1;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            pointer-events: none;
        }
        .footer > * {
            pointer-events: auto;
        }
        .earthen-logo {
            width: 33px;
            height: 33px;
        }
        @media screen and (min-width: 769px) and (max-width: 1200px) {
            .earthcal-logo {
                width: 155px;
            }
        }
        @media screen and (min-width: 1201px) {
            .earthcal-logo {
                width: 177px;
            }
        }
    </style>
</head>
<body>
    <div id="initial-load" aria-hidden="true">
        <img class="earthcal-logo" src="/svgs/earthcal-icon.svg" alt="EarthCal logo" aria-hidden="true">
        <div id="authenticating-text" role="status" aria-live="polite">
            <span>Authenticating with Buwana</span>
            <span id="dots">...</span>
        </div>
        <div class="footer" style="text-align: center">
            <span class="earthen-logo-wrapper" aria-label="Visit Earthen">
                <img class="earthen-logo" src="https://earthcal.app/svgs/earthen-icon.svg" alt="Earthen logo">
            </span>
            <p id="logo-text" class="footer-text" style="font-size: smaller;">EarthCal v1.0 by Earthen</p>
        </div>
    </div>

<script>
    function readStoredThemePreference() {
        try {
            const stored = localStorage.getItem('user_dark_mode')
                || localStorage.getItem('dark-mode-toggle');

            if (!stored) return null;

            const normalized = String(stored).toLowerCase();
            if (normalized === 'dark' || normalized === 'light') {
                return normalized;
            }

            if (normalized === 'true') return 'dark';
            if (normalized === 'false') return 'light';

            return null;
        } catch (error) {
            console.warn('[Theme] Unable to read stored preference', error);
            return null;
        }
    }

    function detectPreferredTheme() {
        const stored = readStoredThemePreference();
        if (stored) {
            return stored;
        }

        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            return 'dark';
        }

        return 'light';
    }

    function applyPreferredTheme(theme) {
        const body = document.body;
        if (!body) return;

        body.classList.remove('theme-dark', 'theme-light');
        body.classList.add(theme === 'dark' ? 'theme-dark' : 'theme-light');
    }

    const initialTheme = detectPreferredTheme();
    applyPreferredTheme(initialTheme);

    if (window.matchMedia) {
        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const handleMediaChange = () => {
            const stored = readStoredThemePreference();
            if (!stored) {
                applyPreferredTheme(mediaQuery.matches ? 'dark' : 'light');
            }
        };

        if (typeof mediaQuery.addEventListener === 'function') {
            mediaQuery.addEventListener('change', handleMediaChange);
        } else if (typeof mediaQuery.addListener === 'function') {
            mediaQuery.addListener(handleMediaChange);
        }
    }

    window.addEventListener('storage', (event) => {
        if (event.key === 'user_dark_mode' || event.key === 'dark-mode-toggle') {
            applyPreferredTheme(detectPreferredTheme());
        }
    });

    // Animate dots
    let dotPhase = 0;
    const dotElem = document.getElementById("dots");
    setInterval(() => {
        dotPhase = (dotPhase % 3) + 1;
        dotElem.textContent = ".".repeat(dotPhase);
    }, 400);

    const OIDC_FALLBACK_MAX_AGE = 10 * 60 * 1000; // 10 minutes

    function readOidcFallback(key) {
        try {
            if (!window.name) return null;
            const payload = JSON.parse(window.name);
            const data = payload.__earthcal_oidc || payload;
            if (!data || typeof data !== 'object') return null;
            if (data.timestamp && Date.now() - data.timestamp > OIDC_FALLBACK_MAX_AGE) {
                clearOidcFallback();
                return null;
            }
            return data[key] ?? null;
        } catch (error) {
            console.warn('[OIDC] Unable to read fallback auth data:', error);
            return null;
        }
    }

    function clearOidcFallback() {
        try {
            if (!window.name) return;
            const payload = JSON.parse(window.name);
            if (payload.__earthcal_oidc) {
                delete payload.__earthcal_oidc;
            }
            if (Object.keys(payload).length === 0) {
                window.name = '';
            } else {
                window.name = JSON.stringify(payload);
            }
        } catch (error) {
            window.name = '';
        }
    }

    (async function() {
        // ðŸ› ï¸ Some providers incorrectly append query parameters using '?' instead of '&'.
        //    Normalize the query string so code and state can be parsed reliably.
        let search = window.location.search;
        if ((search.match(/\?/g) || []).length > 1) {
            const parts = search.split('?');
            search = '?' + parts.slice(1).join('&');
            const newUrl = window.location.pathname + search + window.location.hash;
            window.history.replaceState({}, '', newUrl);
        }

        const urlParams = new URLSearchParams(search);
        const code = urlParams.get("code");
        const state = urlParams.get("state");

        const reservedParamKeys = new Set(["code", "state", "session_state"]);
        const forwardedParams = new URLSearchParams();
        urlParams.forEach((value, key) => {
            if (!value || reservedParamKeys.has(String(key).toLowerCase())) {
                return;
            }
            forwardedParams.append(key, value);
        });

        if (!code || !state) {
            console.error("Missing code or state in callback");
            alert("Login failed: missing parameters.");
            return;
        }

        const storedState = sessionStorage.getItem("oidc_state");
        const expectedState = storedState || readOidcFallback("oidc_state");
        if (state !== expectedState) {
            console.error("State mismatch.");
            alert("Login failed: invalid state.");
            return;
        }

        const storedCodeVerifier = sessionStorage.getItem("pkce_code_verifier");
        const codeVerifier = storedCodeVerifier || readOidcFallback("pkce_code_verifier");
        if (!codeVerifier) {
            console.error("Missing code_verifier");
            alert("Login failed: missing code_verifier.");
            return;
        }

        try {
            const tokenResponse = await fetch("https://buwana.ecobricks.org/token", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded" },
                body: new URLSearchParams({
                    grant_type: "authorization_code",
                    code: code,
                    redirect_uri: "https://earthcal.app/auth/callback",
                    client_id: "ecal_7f3da821d0a54f8a9b58",
                    code_verifier: codeVerifier
                })
            });

            if (!tokenResponse.ok) throw new Error("Token exchange failed");

            const tokenData = await tokenResponse.json();

            if (!tokenData.id_token || !tokenData.access_token) {
                throw new Error("Missing tokens in response");
            }

            const idPayload = JSON.parse(atob(tokenData.id_token.split('.')[1]));
            console.log("ID Token Payload:", idPayload);

            const ensureForwardParam = (key, value) => {
                if (!value || forwardedParams.has(key)) {
                    return;
                }
                forwardedParams.set(key, value);
            };

            ensureForwardParam("firstname", idPayload.given_name || idPayload.name);
            ensureForwardParam("first_name", idPayload.given_name || idPayload.name);
            ensureForwardParam("buwana_id", idPayload.buwana_id);
            ensureForwardParam("id", idPayload.buwana_id);

            const supportedLangs = ['en','es','id','fr','zh','ar','de'];
            let lang = (navigator.language || 'en').slice(0,2).toLowerCase();
            if (!supportedLangs.includes(lang)) lang = 'en';

            const checkResp = await fetch(
                `https://buwana.ecobricks.org/api/check_user_app_connection.php?buwana_id=${idPayload.buwana_id}&client_id=ecal_7f3da821d0a54f8a9b58`,
                { credentials: 'include' }
            );
            let checkData = null;
            try {
                checkData = await checkResp.clone().json();
            } catch (parseErr) {
                console.warn('Connection check response not JSON', parseErr);
            }

            if (checkResp.redirected) {
                window.location.href = checkResp.url;
                return;
            }
            if (!checkResp.ok || !checkData || checkData.connected !== true) {
                const connectUrl =
                    (checkData && checkData.app_login_url)
                        ? checkData.app_login_url
                        : `https://buwana.ecobricks.org/${lang}/app-connect.php?id=${idPayload.buwana_id}&client_id=ecal_7f3da821d0a54f8a9b58`;
                window.location.href = connectUrl;
                return;
            }

            localStorage.setItem("id_token", tokenData.id_token);
            localStorage.setItem("access_token", tokenData.access_token);
            localStorage.setItem("token_type", tokenData.token_type);
            localStorage.setItem("expires_in", tokenData.expires_in);
            localStorage.setItem("user_profile", JSON.stringify(idPayload));

            sessionStorage.removeItem("pkce_code_verifier");
            sessionStorage.removeItem("oidc_state");
            sessionStorage.removeItem("oidc_nonce");
            clearOidcFallback();

            window.history.replaceState({}, document.title, "/auth/callback");

            const redirectQuery = forwardedParams.toString();
            const redirectUrl = redirectQuery
                ? `/index.html?${redirectQuery}`
                : "/index.html";
            window.location.href = redirectUrl;

        } catch (err) {
            console.error("Authentication error:", err);
            alert("Login failed. Please try again.");
        }
    })();
</script>
</body>
</html>
